Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn","Ext.tab.*"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var s=50;
var d=javafree.CONTEXTPATH+"/security/resource/doGetMemuRecourceTreeJson";var w=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"description",type:"string"},{name:"url",type:"string"},{name:"type",type:"string"},{name:"childreCount",type:"int"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:d},folderSort:false});
w.sort({property:"sn",direction:"ASC"},"prepend",false);var q=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"",scope:this,handler:function(){l.getEl().mask("正在展开...");l.expandAll(function(){l.getEl().unmask();});}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"",handler:function(){l.collapseAll();
}},{width:180,fieldLabel:"查询",emptyText:"模块名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:w}];var c="";var l=Ext.create("Ext.tree.Panel",{title:"",tbar:q,useArrows:false,rootVisible:false,autoScroll:true,containerScroll:true,store:w,multiSelect:true,forceFit:true,columns:[{xtype:"treecolumn",text:"功能模块名称",width:280,sortable:true,dataIndex:"note"}],listeners:{"itemclick":function(O,N,R,P,S,Q){c=N.data.id;
Ext.apply(D.proxy.extraParams,{"menuid":N.data.id});D.load();}}});var I=javafree.CONTEXTPATH+"/security/function/doGetRecourceTreeJson";var D=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"description",type:"string"},{name:"url",type:"string"},{name:"type",type:"string"},{name:"childreCount",type:"int"},{name:"sn",type:"int"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:I,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:true,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});
var L=[{width:150,fieldLabel:"查询",emptyText:"资源名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border: 1px solid #fff!important",store:D},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/add.png",text:"新增",handler:function(){C.add_btn_fn();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit.png",text:"编辑",handler:function(){C.edit_btn_fn();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除",handler:function(){C.doDelRes();}},"-",{pressed:false,icon:ICONPATH+"button/group_key.png",cls:"x-btn-text-icon",text:"选择授权对象",handler:function(){C.doSelect_auth_fn();}}];var C={add_btn_fn:function(O){var N=javafree.CONTEXTPATH+"/security/function/doGetResource?parentWinGridPanelID="+k.getId()+"&menu_id="+c;
javafree.CenterPanel.popupWindow(N,"新增资源信息");},edit_btn_fn:function(P){var N=k.getSelectionModel().getSelection();if(N.length>0){if(N.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var O=javafree.CONTEXTPATH+"/security/function/doGetResource?id="+N[0].get("id")+"&parentWinGridPanelID="+k.getId();
javafree.CenterPanel.popupWindow(O,"编辑资源信息");}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doSelect_auth_fn:function(){var P=k.getSelectionModel().getSelection();if(P.length>0){var O=[];for(var R=0,N=P.length;R<N;R++){O.push(P[R].get("id"));
}var Q=javafree.CONTEXTPATH+"/security/function/doGetSelectAuthList?parentWinGridPanelID_user="+b.getId()+"&parentWinGridPanelID_role="+j.getId()+"&parentWinGridPanelID_dept="+m.getId()+"&parentWinGridPanelID_group="+h.getId()+"&parentWinGridPanelID_org="+A.getId()+"&parentWinGridPanelID_tab="+e.getId()+"&current_resids="+O.toString();
javafree.CenterPanel.popupWindow(Q,"选择授权对象",800,580);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您先选中将要分配的安全资源!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doDelRes:function(){var O=k.getSelectionModel().getSelection();if(O.length>0){var O=k.getSelectionModel().getSelection();var R=[];
for(var Q=0,N=O.length;Q<N;Q++){R.push(O[Q].get("id"));}var P=javafree.CONTEXTPATH+"/security/function/doDelRes?IDS="+R.toString();this.doPostRequest(P);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doPostRequest:function(N){Ext.Ajax.request({url:N,method:"GET",scope:this,success:function(O){var P=Ext.JSON.decode(O.responseText);
if(P.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:P.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){k.store.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:P.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(O){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}};var n=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function J(O,P,N){if("MENU"==N.get("type")){return"功能菜单";}else{if("FUNCTION"==N.get("type")){return"类或类的方法";}else{if("BUTTON"==N.get("type")){return"页面元素";}else{return O;}}}}var k=Ext.create("Ext.grid.Panel",{title:"",tbar:L,selModel:n,multiSelect:true,forceFit:true,store:D,selType:"cellmodel",plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:7})],viewConfig:{enableTextSelection:true},columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"编码",dataIndex:"code",width:160,editor:{allowBlank:false}},{header:"名称",width:200,sortable:true,dataIndex:"note",editor:{allowBlank:false}},{header:"类型",width:100,sortable:true,dataIndex:"type",renderer:J,},{header:"说明",width:180,sortable:true,dataIndex:"description",hidden:true},{header:"次序号",dataIndex:"sn",sortable:true,align:"center",width:70,hidden:true}],listeners:{"itemclick":function(O,N,R,P,S,Q){Ext.apply(t.proxy.extraParams,{"resourceid":N.data.id});
t.load({callback:function(U,T,W){if(W){var V=0;e.items.each(function(X){++V;if(V==1){X.setTitle("用户("+U.length+")");}});}}});Ext.apply(H.proxy.extraParams,{"resourceid":N.data.id});H.load({callback:function(U,T,W){if(W){var V=0;e.items.each(function(X){++V;if(V==2){X.setTitle("机构/部门("+U.length+")");}});
}}});Ext.apply(y.proxy.extraParams,{"resourceid":N.data.id});y.load({callback:function(U,T,W){if(W){var V=0;e.items.each(function(X){++V;if(V==3){X.setTitle("角色("+U.length+")");}});}}});Ext.apply(F.proxy.extraParams,{"resourceid":N.data.id});F.load({callback:function(U,T,W){if(W){var V=0;e.items.each(function(X){++V;
if(V==4){X.setTitle("组群("+U.length+")");}});}}});Ext.apply(u.proxy.extraParams,{"resourceid":N.data.id});u.load({callback:function(U,T,W){if(W){var V=0;e.items.each(function(X){++V;if(V==5){X.setTitle("机构编码("+U.length+")");}});}}});}},bbar:{xtype:"pagingtoolbar",store:D,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var z=Ext.create("Ext.panel.Panel",{layout:{type:"border"},defaults:{split:true},items:[{region:"west",title:"",split:false,width:"28%",border:false,minWidth:100,maxSize:400,autoScroll:true,containerScroll:true,layout:"fit",items:l},{region:"center",width:"72%",style:{borderLeft:"1px solid #cecece"},border:false,minWidth:300,maxSize:800,split:false,autoScroll:true,layout:"fit",floatable:true,items:k}]});
var K={doDelResOrgcode:function(T,O){var P=T.getSelectionModel().getSelection();if(P.length>0){var P=T.getSelectionModel().getSelection();var S=[];for(var R=0,N=P.length;R<N;R++){S.push(P[R].get("id"));}var Q=javafree.CONTEXTPATH+"/security/resourceorg/doDelResOrg?IDS="+S.toString();this.doPostRequest(Q,T,O);
}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doDelResAuth:function(T,O){var P=T.getSelectionModel().getSelection();if(P.length>0){var P=T.getSelectionModel().getSelection();var S=[];for(var R=0,N=P.length;R<N;R++){S.push(P[R].get("id"));
}var Q=javafree.CONTEXTPATH+"/security/resourceauth/doDelResAuth?IDS="+S.toString();this.doPostRequest(Q,T,O);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doPostRequest:function(O,P,N){Ext.Ajax.request({url:O,method:"POST",scope:this,success:function(Q){var R=Ext.JSON.decode(Q.responseText);
if(R.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:R.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){P.store.load({callback:function(T,S,V){if(V){var U=0;e.items.each(function(W){++U;if(U==N){if(U==1){W.setTitle("用户("+T.length+")");}if(U==2){W.setTitle("机构/部门("+T.length+")");
}if(U==3){W.setTitle("角色("+T.length+")");}if(U==4){W.setTitle("组群("+T.length+")");}if(U==5){W.setTitle("机构编码("+T.length+")");}}});}}});}});}else{Ext.MessageBox.show({title:"错误提示:",msg:R.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(Q){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}};var M=javafree.CONTEXTPATH+"/security/resourceauth/doGetResAuthGridJson";var t=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:M+"?fromType=U",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var i=[{width:200,fieldLabel:"查询",emptyText:"用户名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:t},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权用户",handler:function(){K.doDelResAuth(b,1);
}}];var B=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var b=Ext.create("Ext.grid.Panel",{title:"",tbar:i,selModel:B,multiSelect:true,forceFit:true,store:t,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:t,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var H=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:M+"?fromType=D",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var x=[{width:200,fieldLabel:"查询",emptyText:"机构名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:H},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权部门",handler:function(){K.doDelResAuth(m,2);
}}];var p=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var m=Ext.create("Ext.grid.Panel",{title:"",tbar:x,selModel:p,multiSelect:true,forceFit:true,store:H,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"机构名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:H,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var y=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:M+"?fromType=R",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var E=[{width:200,fieldLabel:"查询",emptyText:"角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:y},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权角色",handler:function(){K.doDelResAuth(j,3);
}}];var o=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var j=Ext.create("Ext.grid.Panel",{title:"",tbar:E,selModel:o,multiSelect:true,forceFit:true,store:y,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"角色名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:y,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var F=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:M+"?fromType=G",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var g=[{width:200,fieldLabel:"查询",emptyText:"组群名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:F},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权群组",handler:function(){K.doDelResAuth(h,4);
}}];var G=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var h=Ext.create("Ext.grid.Panel",{title:"",tbar:g,selModel:G,multiSelect:true,forceFit:true,store:F,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"组群名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:F,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var v=javafree.CONTEXTPATH+"/security/resourceorg/doGetResOrgGridJson";var u=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"orgcode_name",type:"string"},{name:"orgcode",type:"string"},{name:"resource_name",type:"string"}],pageSize:s,proxy:{type:"jsonp",enablePaging:true,url:v,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"orgcode",direction:"ASC"}});
var f=[{width:200,fieldLabel:"查询",emptyText:"编码名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:u},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权机构编码",handler:function(){K.doDelResOrgcode(A,5);
}}];var a=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var A=Ext.create("Ext.grid.Panel",{title:"",tbar:f,selModel:a,multiSelect:true,forceFit:true,store:u,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"编码名称",dataIndex:"orgcode_name",width:140},{header:"编码",dataIndex:"orgcode",width:120}],bbar:{xtype:"pagingtoolbar",store:u,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var e=Ext.widget("tabpanel",{activeTab:0,tabPosition:"top",items:[{title:"用户",iconCls:"btn-icon-md  orange2 fa fa-user",layout:"fit",items:b},{title:"机构/部门",iconCls:"btn-icon-md orange2 fa fa-sitemap",layout:"fit",items:m},{title:"角色",iconCls:"btn-icon-md orange2 fa fa-child",layout:"fit",items:j},{title:"组群",iconCls:"btn-icon-md orange2 fa fa-users",layout:"fit",items:h},{title:"机构编码",iconCls:"btn-icon-md  orange2 fa fa-qrcode",layout:"fit",items:A}]});
var r=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderBottom:"1px solid #cecece"},defaults:{split:true},items:[{region:"west",split:true,width:"60%",border:false,minWidth:400,maxSize:900,autoScroll:true,layout:"fit",items:z},{region:"center",width:"40%",border:false,minWidth:250,maxSize:700,split:true,autoScroll:true,layout:"fit",floatable:true,items:e}]});
javafree.CenterPanel.addCmp(r);});