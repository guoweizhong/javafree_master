Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn","Ext.tab.*"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";var res_treePanel_id=Ext.id();
var res_treePanel_fn_public={delete_btn_fn:function(a){if(""!=a&&a.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",function(b,c){res_treePanel_fn_public.delete_Detai(b,a);});}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},edit_btn_fn:function(b){var a=Ext.getCmp(res_treePanel_id);
if(""!=b&&b.length>0){var c=javafree.CONTEXTPATH+"/security/resource/doGetMenu?id="+b+"&parentWinGridPanelID="+a.getId();javafree.CenterPanel.popupWindow(c,"编辑菜单资源信息",860,650);}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},delete_Detai:function(d,b){if(d=="yes"){var a=Ext.getCmp(res_treePanel_id);
var c=javafree.CONTEXTPATH+"/security/resource/doDelRes";Ext.Ajax.request({url:c,method:"GET",scope:this,params:{"IDS":b},success:function(e){var f=Ext.JSON.decode(e.responseText);if(f.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:f.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){a.store.load();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:f.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(e){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}};Ext.onReady(function(){var y=50;var e="";
var f=javafree.CONTEXTPATH+"/security/resource/doGetMemuRecourceTreeJson";var v=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"description",type:"string"},{name:"url",type:"string"},{name:"type",type:"string"},{name:"reg_src",type:"string"},{name:"tagettype",type:"string"},{name:"iconcls",type:"string"},{name:"childreCount",type:"int"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:f},folderSort:false});
v.sort({property:"sn",direction:"ASC"},"prepend",false);var n={doSelect_auth_fn:function(){var K=z.getSelectionModel().getSelection();if(K.length>0){var J=[];for(var M=0,I=K.length;M<I;M++){J.push(K[M].get("id"));}var L=javafree.CONTEXTPATH+"/security/resource/doGetSelectAuthList?parentWinGridPanelID_user="+C.getId()+"&parentWinGridPanelID_role="+w.getId()+"&parentWinGridPanelID_dept="+s.getId()+"&parentWinGridPanelID_group="+F.getId()+"&parentWinGridPanelID_org="+o.getId()+"&parentWinGridPanelID_tab="+u.getId()+"&current_resids="+J.toString();
javafree.CenterPanel.popupWindow(L,"选择授权对象",800,580);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您先选中将要分配的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doAdd_menu_fn:function(){var I=javafree.CONTEXTPATH+"/security/resource/doGetMenu?parentWinGridPanelID="+z.getId()+"&menu_id="+e;
javafree.CenterPanel.popupWindow(I,"新增菜单信息",860,650);},edit_btn_fn:function(K){var I=z.getSelectionModel().getSelection();if(I.length>0){if(I.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{if("INPUT"==I[0].get("reg_src")){var J=javafree.CONTEXTPATH+"/security/resource/doGetMenu?id="+I[0].get("id")+"&parentWinGridPanelID="+z.getId();
javafree.CenterPanel.popupWindow(J,"编辑菜单资源信息",860,650);}else{Ext.MessageBox.show({title:"提示",msg:"只能编辑”手工录入“类型记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的菜单记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doDelRes:function(){var J=z.getSelectionModel().getSelection();
if(J.length>0){var J=z.getSelectionModel().getSelection();var M=[];for(var L=0,I=J.length;L<I;L++){M.push(J[L].get("id"));}var K=javafree.CONTEXTPATH+"/security/resource/doDelRes?IDS="+M.toString();this.doPostRequest(K);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}},doReloadMenu_btn_fn:function(){var I=javafree.CONTEXTPATH+"/security/resource/doReloadMenu";Ext.Ajax.request({url:I,method:"GET",scope:this,success:function(J){var K=Ext.JSON.decode(J.responseText);if(K.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:K.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){window.location.reload();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:K.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(J){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});},doSynchMenu_btn_fn:function(){var I=javafree.CONTEXTPATH+"/security/resource/doMenuSynch";
this.doPostRequest(I);},doPostRequest:function(I){Ext.Ajax.request({url:I,method:"GET",scope:this,success:function(J){var K=Ext.JSON.decode(J.responseText);if(K.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:K.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){z.store.load();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:K.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(J){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}};var q=[{width:150,fieldLabel:"查询",emptyText:"菜单名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:v},{pressed:false,icon:ICONPATH+"button/add.png",cls:"x-btn-text-icon",text:"录入",handler:function(){n.doAdd_menu_fn();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit.png",text:"编辑",handler:function(){n.edit_btn_fn();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除",handler:function(){n.doDelRes();}},"-",{pressed:false,icon:ICONPATH+"button/group_key.png",cls:"x-btn-text-icon",text:"选择授权对象",handler:function(){n.doSelect_auth_fn();
}},"-",{pressed:false,xtype:"splitbutton",cls:"x-btn-text-icon",icon:ICONPATH+"button/menu-show.png",text:"更多操作",menu:[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"全部展开",scope:this,handler:function(){z.getEl().mask("正在展开...");z.expandAll(function(){z.getEl().unmask();
});}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"全部折叠",handler:function(){z.collapseAll();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/database_refresh.png",text:"同步到数据库",handler:function(){n.doSynchMenu_btn_fn();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/table_refresh.png",text:"重新加载菜单",handler:function(){n.doReloadMenu_btn_fn();
}}]}];var E=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function j(J,K,I){J=I.get("reg_src");if("IPNUT"==I.get("reg_src")){return"手工录入";}else{return"系统配置";}}var z=Ext.create("Ext.tree.Panel",{id:res_treePanel_id,title:"",tbar:q,useArrows:false,rootVisible:false,store:v,selModel:E,multiSelect:true,forceFit:true,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{xtype:"treecolumn",text:"菜单名称",width:180,sortable:true,dataIndex:"note"},{text:"菜单URL",width:240,sortable:true,hidden:true,dataIndex:"url"},{text:"数据来源",width:45,sortable:true,dataIndex:"reg_src",hidden:true,renderer:j},{text:"说明",width:100,sortable:true,dataIndex:"description",hidden:true},{text:"跳转方式",width:100,sortable:true,dataIndex:"tagettype",hidden:true},{text:"图标样式",width:100,sortable:true,dataIndex:"iconcls",hidden:true},{text:"编码",width:100,sortable:true,dataIndex:"code",hidden:true},{text:"次序号",width:70,sortable:true,align:"center",dataIndex:"sn",hidden:true},{sortable:false,width:90,text:"操作",renderer:function(L,K,I){var M=I.get("id");
var J="<div class='visible-md visible-lg hidden-sm hidden-xs action-buttons'>"+"<a class='green' href='javascript:res_treePanel_fn_public.edit_btn_fn(\""+M+"\")'  data-rel='tooltip'  title='编辑内容' ><i class='fa fa-pencil bigger-130'></i></a>&nbsp;&nbsp;"+"<a class='red' href='javascript:res_treePanel_fn_public.delete_btn_fn(\""+M+"\")' data-rel='tooltip'  title='删除' ><i class='fa fa-trash bigger-130'></i></a>"+"</div>";
return J;}}],listeners:{"itemclick":function(J,I,M,K,N,L){e=I.data.id;Ext.apply(m.proxy.extraParams,{"resourceid":I.data.id});m.load({callback:function(P,O,R){if(R){var Q=0;u.items.each(function(S){++Q;if(Q==1){S.setTitle("用户("+P.length+")");}});}}});Ext.apply(b.proxy.extraParams,{"resourceid":I.data.id});
b.load({callback:function(P,O,R){if(R){var Q=0;u.items.each(function(S){++Q;if(Q==2){S.setTitle("机构/部门("+P.length+")");}});}}});Ext.apply(a.proxy.extraParams,{"resourceid":I.data.id});a.load({callback:function(P,O,R){if(R){var Q=0;u.items.each(function(S){++Q;if(Q==3){S.setTitle("角色("+P.length+")");}});
}}});Ext.apply(B.proxy.extraParams,{"resourceid":I.data.id});B.load({callback:function(P,O,R){if(R){var Q=0;u.items.each(function(S){++Q;if(Q==4){S.setTitle("组群("+P.length+")");}});}}});Ext.apply(h.proxy.extraParams,{"resourceid":I.data.id});h.load({callback:function(P,O,R){if(R){var Q=0;u.items.each(function(S){++Q;
if(Q==5){S.setTitle("机构编码("+P.length+")");}});}}});}}});var d={doDelResOrgcode:function(O,J){var K=O.getSelectionModel().getSelection();if(K.length>0){var K=O.getSelectionModel().getSelection();var N=[];for(var M=0,I=K.length;M<I;M++){N.push(K[M].get("id"));}var L=javafree.CONTEXTPATH+"/security/resourceorg/doDelResOrg?IDS="+N.toString();
this.doPostRequest(L,O,J);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doDelResAuth:function(O,J){var K=O.getSelectionModel().getSelection();if(K.length>0){var K=O.getSelectionModel().getSelection();var N=[];for(var M=0,I=K.length;
M<I;M++){N.push(K[M].get("id"));}var L=javafree.CONTEXTPATH+"/security/resourceauth/doDelResAuth?IDS="+N.toString();this.doPostRequest(L,O,J);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的菜单项!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},doPostRequest:function(J,K,I){Ext.Ajax.request({url:J,method:"POST",scope:this,success:function(L){var M=Ext.JSON.decode(L.responseText);
if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){K.store.load({callback:function(O,N,Q){if(Q){var P=0;u.items.each(function(R){++P;if(P==I){if(P==1){R.setTitle("用户("+O.length+")");}if(P==2){R.setTitle("机构/部门("+O.length+")");
}if(P==3){R.setTitle("角色("+O.length+")");}if(P==4){R.setTitle("组群("+O.length+")");}if(P==5){R.setTitle("机构编码("+O.length+")");}}});}}});}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}};var A=javafree.CONTEXTPATH+"/security/resourceauth/doGetResAuthGridJson";var m=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:y,proxy:{type:"jsonp",enablePaging:true,url:A+"?fromType=U",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var k=[{width:200,fieldLabel:"查询",emptyText:"用户名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:m},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权用户",handler:function(){d.doDelResAuth(C,1);
}}];var l=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var C=Ext.create("Ext.grid.Panel",{title:"",tbar:k,selModel:l,multiSelect:true,forceFit:true,store:m,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:m,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var b=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:y,proxy:{type:"jsonp",enablePaging:true,url:A+"?fromType=D",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var c=[{width:200,fieldLabel:"查询",emptyText:"机构名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:b},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权部门",handler:function(){d.doDelResAuth(s,2);
}}];var H=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var s=Ext.create("Ext.grid.Panel",{title:"",tbar:c,selModel:H,multiSelect:true,forceFit:true,store:b,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"机构名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:b,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var a=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:y,proxy:{type:"jsonp",enablePaging:true,url:A+"?fromType=R",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var p=[{width:200,fieldLabel:"查询",emptyText:"角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:a},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权角色",handler:function(){d.doDelResAuth(w,3);
}}];var g=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var w=Ext.create("Ext.grid.Panel",{title:"",tbar:p,selModel:g,multiSelect:true,forceFit:true,store:a,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"角色名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:a,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var B=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"fromType",type:"string"},{name:"authority_name",type:"string"},{name:"orgcode",type:"string"},{name:"creator",type:"string"},{name:"createDate",type:"string"}],pageSize:y,proxy:{type:"jsonp",enablePaging:true,url:A+"?fromType=G",reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"name",direction:"ASC"}});
var x=[{width:200,fieldLabel:"查询",emptyText:"组群名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:B},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权群组",handler:function(){d.doDelResAuth(F,4);
}}];var i=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var F=Ext.create("Ext.grid.Panel",{title:"",tbar:x,selModel:i,multiSelect:true,forceFit:true,store:B,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"组群名称",dataIndex:"name",width:200},{header:"机构编码",width:180,sortable:true,dataIndex:"orgcode"},{header:"操作人",width:80,sortable:true,dataIndex:"creator"}],bbar:{xtype:"pagingtoolbar",store:B,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var D=javafree.CONTEXTPATH+"/security/resourceorg/doGetResOrgGridJson";var h=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"orgcode_name",type:"string"},{name:"orgcode",type:"string"},{name:"resource_name",type:"string"}],pageSize:y,proxy:{type:"jsonp",enablePaging:true,url:D,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"orgcode",direction:"ASC"}});
var G=[{width:200,fieldLabel:"查询",emptyText:"编码名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:h},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除授权机构编码",handler:function(){d.doDelResOrgcode(o,5);
}}];var r=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var o=Ext.create("Ext.grid.Panel",{title:"",tbar:G,selModel:r,multiSelect:true,forceFit:true,store:h,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"编码名称",dataIndex:"orgcode_name",width:140},{header:"编码",dataIndex:"orgcode",width:120}],bbar:{xtype:"pagingtoolbar",store:h,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var u=Ext.widget("tabpanel",{activeTab:0,tabPosition:"top",items:[{title:"用户",iconCls:"btn-icon-md  orange2 fa fa-user",layout:"fit",items:C},{title:"机构/部门",iconCls:"btn-icon-md orange2 fa fa-sitemap",layout:"fit",items:s},{title:"角色",iconCls:"btn-icon-md orange2 fa fa-child",layout:"fit",items:w},{title:"组群",iconCls:"btn-icon-md orange2 fa fa-users",layout:"fit",items:F},{title:"机构编码",iconCls:"btn-icon-md  orange2 fa fa-qrcode",layout:"fit",items:o}]});
var t=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderBottom:"1px solid #cecece"},defaults:{split:true},items:[{region:"west",split:true,width:"60%",border:false,minWidth:400,maxSize:900,autoScroll:true,layout:"fit",items:z},{region:"center",width:"40%",border:false,minWidth:300,maxSize:800,split:true,autoScroll:true,layout:"fit",floatable:true,items:u}]});
javafree.CenterPanel.addCmp(t);});