Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var o=50;var E=javafree.CONTEXTPATH+"/identity/user/doGetUserByDeptIdGridJson";
var z=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"displayName",type:"string"},{name:"email",type:"string"},{name:"orgcode",type:"string"},{name:"enabled",type:"string"},{name:"createDate",type:"string"},{name:"mobile",type:"string"},{name:"adminType",type:"string"},{name:"domain",type:"string"},{name:"sn",type:"int"}],pageSize:o,proxy:{type:"jsonp",enablePaging:true,url:E,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});
var n=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson?forType=userList";var y=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"domain",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:n},folderSort:false});
y.sort({property:"sn",direction:"ASC"},"prepend",false);var x=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"展开",scope:this,handler:function(){m.getEl().mask("正在展开...");m.expandAll(function(){m.getEl().unmask();});}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"折叠",handler:function(){m.collapseAll();
}},{width:180,fieldLabel:"查询",emptyText:"机构/部门名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:y}];var f="";var m=Ext.create("Ext.tree.Panel",{title:"",tbar:x,useArrows:false,rootVisible:false,store:y,multiSelect:true,forceFit:true,columns:[{xtype:"treecolumn",text:"机构树",width:380,sortable:true,dataIndex:"name"}],listeners:{"itemclick":function(G,F,J,H,K,I){f=F.data.id;
Ext.apply(z.proxy.extraParams,{"deptid":F.data.id});z.load({params:{start:0,limit:o}});}}});var b=Ext.create("Ext.data.Store",{fields:["value","name"],data:[{"value":"displayName","name":"用户名称"},{"value":"name","name":"登录帐号"},{"value":"mobile","name":"电话"},{"value":"email","name":"邮箱"}]});var c=[{fieldLabel:"查询",labelWidth:30,id:"fieldName_userlist",xtype:"combobox",emptyText:"选择字段",name:"fieldName_userlist",displayField:"name",valueField:"value",width:140,store:b,queryMode:"local",listeners:{"select":function(){Ext.apply(z.proxy.extraParams,{"fieldName":Ext.getCmp("fieldName_userlist").getValue()});
}},fieldStyle:"border-right: 0px!important;border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;"},{width:140,fieldLabel:"查询",emptyText:"输入字段值...",hideLabel:true,labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:z},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/add.png",text:"新增",handler:function(){j();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit.png",text:"编辑",handler:function(){D();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除",handler:function(){C();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/arrow-up.png",text:"上移",handler:function(){a();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/arrow-down.png",text:"下移",handler:function(){e();}},"-",{pressed:false,xtype:"splitbutton",cls:"x-btn-text-icon",icon:ICONPATH+"button/menu-show.png",text:"更多操作",menu:[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/reset-sort-order.png",text:"重排序号",handler:function(){g();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit-list-order.png",text:"设置序号",handler:function(){w();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept-role.png",text:"设为超级管理员",handler:function(){B(true);}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/remove-role.png",text:"取消超级管理员",handler:function(){B(false);
}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/org_user_check.png",text:"设为机构管理员",handler:function(){t(true);}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/org_user_del.png",text:"取消机构管理员",handler:function(){t(false);}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/lock.png",text:"锁定账号",handler:function(){p(false);
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/lock-open.png",text:"取消锁定",handler:function(){p(true);}}]}];function j(){var F=javafree.CONTEXTPATH+"/identity/user/doGetUser?currentdeptid="+f+"&parentWinGridPanelID="+l.getId();javafree.CenterPanel.popupWindow(F,"新增用户信息",850,785);}function D(){var F=l.getSelectionModel().getSelection();
if(F.length>0){if(F.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var G=javafree.CONTEXTPATH+"/identity/user/doGetUser?id="+F[0].get("id")+"&currentdeptid="+f+"&parentWinGridPanelID="+l.getId();javafree.CenterPanel.popupWindow(G,"编辑用户信息",850,685);
}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function C(){var F=l.getSelectionModel().getSelection();if(F.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",h);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function h(K){if(K=="yes"){var G=l.getSelectionModel().getSelection();var J=[];for(var I=0,F=G.length;I<F;I++){J.push(G[I].get("id"));}var H=javafree.CONTEXTPATH+"/identity/user/doDelUser";Ext.Ajax.request({url:H,method:"GET",scope:this,params:{"IDS":J.toString()},success:function(L){var M=Ext.JSON.decode(L.responseText);
if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){z.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}}function B(I){var G=l.getSelectionModel().getSelection();if(G.length>0){var K=[];for(var J=0,F=G.length;J<F;J++){K.push(G[J].get("id"));}var H=javafree.CONTEXTPATH+"/identity/user/doSetUserSystemRole";Ext.Ajax.request({url:H,method:"POST",scope:this,params:{"IDS":K.toString(),"isSystem":I,},success:function(L){var M=Ext.JSON.decode(L.responseText);
if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){z.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要修改的用户!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function t(I){var G=l.getSelectionModel().getSelection();if(G.length>0){var K=[];for(var J=0,F=G.length;J<F;J++){K.push(G[J].get("id"));}var H=javafree.CONTEXTPATH+"/identity/user/doSetUserOrgManagerRole";
Ext.Ajax.request({url:H,method:"POST",scope:this,params:{"IDS":K.toString(),"isSystem":I,},success:function(L){var M=Ext.JSON.decode(L.responseText);if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){z.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要修改的用户!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function p(K){var G=l.getSelectionModel().getSelection();
if(G.length>0){var J=[];for(var I=0,F=G.length;I<F;I++){J.push(G[I].get("id"));}var H=javafree.CONTEXTPATH+"/identity/user/doSetUserEnabled";Ext.Ajax.request({url:H,method:"POST",scope:this,params:{"IDS":J.toString(),"isEnabled":K,},success:function(L){var M=Ext.JSON.decode(L.responseText);if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){z.load();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要修改的用户!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function i(F,G){Ext.Ajax.request({url:F,method:"GET",scope:this,success:function(H){var I=Ext.JSON.decode(H.responseText);if(I.success==true){if(G){Ext.MessageBox.alert({title:"提示信息:",msg:I.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){return true;}});}else{return true;}}else{Ext.MessageBox.show({title:"错误提示:",msg:I.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
}},failure:function(H){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}function r(K){var G=l;var N=G.getStore();var M=javafree.CONTEXTPATH+"/identity/user/doSetDrag";var U=G.getSelectionModel().getSelection();if(U.length>0){if(U.length>1){Ext.MessageBox.show({title:"提示：",msg:"每次只能移动一行数据！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var F=U[0].get("id");var I=N.getById(F);var O=N.indexOf(I);if(("above"==K)&&(O>0)){var R=O-1;var P=N.getAt(R);var T=P.get("id");var W=P.get("sn");var H=I.get("sn");H=H<2?2:H;W=W<1?1:W;if(W==H){H=W+1;}I.set("sn",W);P.set("sn",H);N.removeAt(O);N.insert(O-1,I);G.getSelectionModel().select(I);var J=M+"?type=above&dropNodeId="+F+"&targetId="+T;
i(J,false);}if(("below"==K)&&(O<N.getCount()-1)){var Q=O+1;var S=N.getAt(Q);var L=S.get("id");var H=I.get("sn");var V=S.get("sn");H=H<1?1:H;V=V<2?2:V;if(H==V){V=H+1;}I.set("sn",V);S.set("sn",H);N.removeAt(O);N.insert(O+1,I);G.getSelectionModel().select(I);var J=M+"?type=below&dropNodeId="+F+"&targetId="+L;
i(J,false);}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要移动的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function a(){r("above");}function e(){r("below");}function w(){var G=l.getSelectionModel().getSelection();if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var F=G[0];Ext.MessageBox.show({title:"设置用户序号...",msg:'用户：" '+F.get("displayName")+"("+F.get("name")+') "当前序号为："'+F.get("sn")+'" <br />   请输入新的序号...',buttonText:{ok:"确定",cancel:"取消"},prompt:true,value:F.get("sn"),fn:v,icon:Ext.MessageBox.INFO});}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function g(){Ext.MessageBox.show({title:"设置当前列表顺序号！",msg:'重排当前列表顺序号，<br />请指定序号起始值，默认为"1"',buttonText:{yes:"确定",cancel:"取消"},prompt:true,fn:v,value:1,icon:Ext.MessageBox.QUESTION});}function v(H,L){if(H=="yes"||H=="ok"){if(!(L.length>0&&(Math.round(L)==L))){Ext.MessageBox.show({title:"错误提示:",msg:'序号"'+L+'"格式错识，请输入整型数字！',buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
return;}var G=javafree.CONTEXTPATH+"/identity/user/doSetOrder?order="+Math.round(L);if(H=="yes"){var K=G+"&type=root&currentdeptid="+f;s(K);}else{var F=l.getSelectionModel().getSelection();if(F.length>0){if(F.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能选择一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var I=F[0];var J=I.get("id");if(H=="ok"){var K=G+"&type=setorder&nodeId="+J;s(K);}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}}}function s(F){Ext.Ajax.request({url:F,method:"GET",scope:this,success:function(G){Ext.apply(z.proxy.extraParams,{"deptid":f});
z.load({params:{start:0,limit:o}});},failure:function(G){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}var q=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function A(G,H,F){if(G=="Y"){return"是";
}else{return"否";}}function d(G,H,F){G=F.get("displayName");if("SYSTEM"==F.get("adminType")){return'<span  unselectable="on" class="orange2 fa fa-star-o bigger-130" style="padding-right:6px" title="超级管理员"></span>'+G;}else{if("ORG"==F.get("adminType")){return'<span  unselectable="on" class="blue fa fa-star-o bigger-130"  style="padding-right:6px" title="机构管理员"></span>'+G;
}else{return G;}}}var l=Ext.create("Ext.grid.Panel",{title:"",tbar:c,selModel:q,multiSelect:true,forceFit:true,store:z,selType:"cellmodel",viewConfig:{enableTextSelection:true},plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:7})],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"display_name",renderer:d,locked:true,width:190},{header:"帐号",dataIndex:"name",width:150},{header:"电话",dataIndex:"mobile",width:130,editor:{allowBlank:false}},{header:"邮箱",dataIndex:"email",width:190,editor:{allowBlank:false}},{header:"机构编码",width:100,sortable:true,dataIndex:"orgcode"},{text:"有效",width:60,sortable:true,renderer:A,dataIndex:"enabled"},{header:"最近修改时间",dataIndex:"createDate",align:"center",width:160,hidden:true},{header:"次序号",dataIndex:"sn",sortable:true,align:"center",width:70,editor:{xtype:"numberfield",allowBlank:false,minValue:0,maxValue:100000}}],bbar:{xtype:"pagingtoolbar",store:z,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
l.on("edit",u,this);function u(){var F="",I="";var G=l.getSelectionModel().getSelection();if(G.length>0){F=G[0].get("id");I=G[0].get("sn");var H=javafree.CONTEXTPATH+"/identity/user/doEditUserSn";Ext.Ajax.request({url:H,method:"POST",scope:this,params:{"ID":F,"SN":I,},success:function(J){var K=Ext.JSON.decode(J.responseText);
if(K.success==true){}else{Ext.MessageBox.show({title:"错误提示:",msg:K.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(J){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}var k=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderBottom:"1px solid #cecece"},defaults:{split:true},items:[{region:"west",title:"",split:true,width:"30%",border:false,minWidth:200,maxSize:500,autoScroll:true,layout:"fit",items:m},{region:"center",width:"70%",border:false,minWidth:400,maxSize:900,split:true,autoScroll:true,layout:"fit",floatable:true,items:l}]});
javafree.CenterPanel.addCmp(k);});