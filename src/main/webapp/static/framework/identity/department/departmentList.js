Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var A=50;var u=javafree.CONTEXTPATH+"/identity/membership/doGetMembershipGridJson";
var x=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"principal",type:"string"},{name:"department_id",type:"string"},{name:"role_id",type:"string"},{name:"user_id",type:"string"},{name:"name",type:"string"},{name:"orgcode",type:"string"},{name:"sn",type:"int"}],pageSize:A,proxy:{type:"jsonp",enablePaging:true,url:u,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});
var n=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson";var t=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"orgcode",type:"string"},{name:"createDate",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:n},folderSort:true});
t.sort({property:"sn",direction:"ASC"},"prepend",false);var s=[{width:160,fieldLabel:"查询",emptyText:"机构/部门名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:t},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/add.png",text:"新增",handler:function(){F.add_btn_fn();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit.png",text:"编辑",handler:function(){F.edit_btn_fn();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除",handler:function(){F.delete_btn_fn();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/group_add.png",text:"添加部门成员",handler:function(){y();
}},"-",{pressed:false,xtype:"splitbutton",cls:"x-btn-text-icon",icon:ICONPATH+"button/menu-show.png",text:"更多操作",menu:[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"全部展开",scope:this,handler:function(){l.getEl().mask("正在展开...");l.expandAll(function(){l.getEl().unmask();
});}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"全部折叠",handler:function(){l.collapseAll();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/reset-sort-order.png",text:"重排序号",handler:function(){b();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit-list-order.png",text:"设置序号",handler:function(){v();
}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/addtreesub.png",text:"添加下级",handler:function(){F.add_SubDepartment();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/tree_root.png",text:"设为根节点",handler:function(){o();}}]}];var F={add_btn_fn:function(H){var G=javafree.CONTEXTPATH+"/identity/department/doGetDepartment?parentWinGridPanelID="+l.getId();
javafree.CenterPanel.popupWindow(G,"新增机构信息");},edit_btn_fn:function(I){var G=l.getSelectionModel().getSelection();if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var H=javafree.CONTEXTPATH+"/identity/department/doGetDepartment?id="+G[0].get("id")+"&parentWinGridPanelID="+l.getId();
javafree.CenterPanel.popupWindow(H,"编辑机构信息");}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},delete_btn_fn:function(H){var G=l.getSelectionModel().getSelection();if(G.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",F.delete_Detai);
}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},delete_Detai:function(L){if(L=="yes"){var H=l.getSelectionModel().getSelection();var K=[];for(var J=0,G=H.length;J<G;J++){K.push(H[J].get("id"));}var I=javafree.CONTEXTPATH+"/identity/department/doDelDepartment";
Ext.Ajax.request({url:I,method:"GET",scope:this,params:{"IDS":K.toString()},success:function(M){var N=Ext.JSON.decode(M.responseText);if(N.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:N.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){l.store.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:N.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
}},failure:function(M){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}},add_SubDepartment:function(){var G=l.getSelectionModel().getSelection();if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能选择一个节点！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var H=javafree.CONTEXTPATH+"/identity/department/doGetDepartment?parentid="+G[0].get("id")+"&parentWinGridPanelID="+l.getId();javafree.CenterPanel.popupWindow(H,"编辑域信息");}}else{Ext.MessageBox.show({title:"提示",msg:"请选择节点！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}};function v(){var G=l.getSelectionModel().getSelection();
if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var H=G[0];Ext.MessageBox.show({title:"设置序号...",msg:'" '+H.get("name")+' "当前序号为："'+H.get("sn")+'" <br />   请输入新的序号...',buttonText:{ok:"确定",cancel:"取消"},prompt:true,value:H.get("sn"),fn:w,icon:Ext.MessageBox.INFO});
}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function b(){var G=l.getSelectionModel().getSelection();if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能选择一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{Ext.MessageBox.show({title:"设置当前列表顺序号！",msg:'重排当前"根节点"，还是选中节点的子节点？ <br />请选择...，并指定起始序号，默认为"1"',buttonText:{yes:"根节点",no:"子节点",cancel:"取消"},prompt:true,fn:w,value:1,icon:Ext.MessageBox.QUESTION});}}else{Ext.MessageBox.show({title:"设置当前列表顺序号！",msg:'重排当前"根节点"顺序号，<br />请选择...，并指定起始序号，默认为"1"',buttonText:{yes:"确定",cancel:"取消"},prompt:true,fn:w,value:1,icon:Ext.MessageBox.QUESTION});
}}function w(I,M){if(I=="yes"||I=="no"||I=="ok"){if(!(M.length>0&&(Math.round(M)==M))){Ext.MessageBox.show({title:"错误提示:",msg:'序号"'+M+'"格式错识，请输入整型数字！',buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});return;}var H=javafree.CONTEXTPATH+"/identity/department/doSetOrder?order="+Math.round(M);if(I=="yes"){var L=H+"&type=root";
f(L);}else{var G=l.getSelectionModel().getSelection();if(G.length>0){if(G.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能选择一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var J=G[0];var K=J.get("id");if(I=="ok"){var L=H+"&type=setorder&nodeId="+K;f(L);}else{if(!J.get("leaf")){var L=H+"&type=sub&nodeId="+K;
f(L);}else{Ext.MessageBox.show({title:"信息提示:",msg:'节点"'+J.get("name")+'"没有子节点！',buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}}}function f(G){Ext.Ajax.request({url:G,method:"GET",scope:this,success:function(H){var I=Ext.JSON.decode(H.responseText);
if(I.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:I.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){l.store.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:I.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(H){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}function o(){var G=l.getSelectionModel().getSelection();if(G.length>0){Ext.MessageBox.confirm("提示信息:","您确定将选中的节点设为根节点吗?",D);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要设置为根节点的节点!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function D(L){if(L=="yes"){var H=l.getSelectionModel().getSelection();
var K=[];for(var J=0,G=H.length;J<G;J++){K.push(H[J].get("id"));}var I=javafree.CONTEXTPATH+"/identity/department/doSetTreeRoot";Ext.Ajax.request({url:I,method:"GET",scope:this,params:{"IDS":K.toString()},success:function(M){var N=Ext.JSON.decode(M.responseText);if(N.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:N.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){l.store.load();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:N.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(M){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}var m=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});
function d(H,I,G){if(H=="ORG"){return"机构";}else{return"部门";}}var g;var i;var l=Ext.create("Ext.tree.Panel",{title:"",tbar:s,useArrows:false,rootVisible:false,store:t,selModel:m,multiSelect:true,forceFit:true,columnLines:true,columns:[new Ext.grid.RowNumberer({header:"",width:35}),{xtype:"treecolumn",text:"名称",width:370,sortable:true,dataIndex:"name",locked:true},{text:"类型",width:80,sortable:true,renderer:d,dataIndex:"type"},{text:"机构编码",width:100,sortable:true,dataIndex:"orgcode"},{text:"最近修改时间",width:150,sortable:true,align:"center",dataIndex:"createDate"},{text:"次序号",width:70,sortable:true,align:"center",dataIndex:"sn"}],listeners:{"itemclick":function(H,G,K,I,L,J){Ext.apply(x.proxy.extraParams,{"deptid":G.data.id});
g=G.data.id;i=G.data.name;x.load({params:{start:0,limit:A},callback:function(N,M,O){if(O){E.setTitle(G.data.name+"-成员列表：");}}});}}});var q=[{width:200,fieldLabel:"查询",emptyText:"用户/机构/角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:x},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit-role.png",text:"改变角色",handler:function(){B();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/convert.png",text:"转换部门",handler:function(){e();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"移除部门成员",handler:function(){r();}}];function B(){var H=E.getSelectionModel().getSelection();if(H.length>0){var K=[];
for(var J=0,G=H.length;J<G;J++){K.push(H[J].get("id"));}var I=javafree.CONTEXTPATH+"/identity/membership/doGetSelectRoleList?parentWinGridPanelID="+E.getId()+"&current_memberids="+K.toString();javafree.CenterPanel.popupWindow(I,"请选择改变角色列表：",620,500);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要改变的成员的记录!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function e(){var H=E.getSelectionModel().getSelection();if(H.length>0){var K=[];for(var J=0,G=H.length;J<G;J++){K.push(H[J].get("id"));}var I=javafree.CONTEXTPATH+"/identity/membership/doGetSelectDeptList?parentWinGridPanelID="+E.getId()+"&current_memberids="+K.toString();javafree.CenterPanel.popupWindow(I,"请选择转换部门：",620,500);
}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要改变的成员的记录!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function y(){if(g&&g.length>0){var G=javafree.CONTEXTPATH+"/identity/department/doGetSelectDeptMemberList?parentWinGridPanelID="+E.getId()+"&current_deptid="+g;javafree.CenterPanel.popupWindow(G,"为“"+i+"”添加成员：",1000,580);
}else{Ext.MessageBox.show({title:"错误提示:",msg:"请先选择左侧机构列表!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function r(){var G=E.getSelectionModel().getSelection();if(G.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",z);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function z(L){if(L=="yes"){var H=E.getSelectionModel().getSelection();var K=[];for(var J=0,G=H.length;J<G;J++){K.push(H[J].get("id"));}var I=javafree.CONTEXTPATH+"/identity/membership/doDelMembership";Ext.Ajax.request({url:I,method:"POST",scope:this,params:{"IDS":K.toString()},success:function(M){var N=Ext.JSON.decode(M.responseText);
if(N.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:N.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){x.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:N.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(M){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}}var k=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function a(H,I,G){if(H=="Y"){return"是";}else{return"否";}}function h(H,I,G){if(H!=""){var J=H.split("|");if(J.length>2){return J[0];}else{return H;}}else{return"";}}function p(H,I,G){if(H!=""){var J=H.split("|");
if(J.length>2){return J[2];}else{return H;}}else{return"";}}var C="成员列表：";var E=Ext.create("Ext.grid.Panel",{title:C,tbar:q,selModel:k,multiSelect:true,forceFit:true,store:x,selType:"cellmodel",plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:4})],columns:[new Ext.grid.RowNumberer({header:"",width:35}),{id:"id",header:"用户名称",dataIndex:"name",renderer:h,width:120},{header:"角色名称",dataIndex:"name",renderer:p,width:140},{header:"主要身份",dataIndex:"principal",width:80,align:"center",hidden:true,renderer:a},{header:"机构编码",dataIndex:"orgcode",width:100},{header:"次序号",dataIndex:"sn",width:70,editor:{xtype:"numberfield",allowBlank:false,minValue:0,maxValue:100000}}],bbar:{xtype:"pagingtoolbar",store:x,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
E.on("edit",c,this);function c(){var G="",J="";var H=E.getSelectionModel().getSelection();if(H.length>0){G=H[0].get("id");J=H[0].get("sn");var I=javafree.CONTEXTPATH+"/identity/membership/doEditMembershipSn";Ext.Ajax.request({url:I,method:"POST",scope:this,params:{"ID":G,"SN":J,},success:function(K){var L=Ext.JSON.decode(K.responseText);
if(L.success==true){}else{Ext.MessageBox.show({title:"错误提示:",msg:L.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(K){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}var j=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderBottom:"1px solid #cecece"},defaults:{split:true},items:[{region:"west",title:"",split:true,width:"55%",border:false,minWidth:300,maxSize:900,autoScroll:true,layout:"fit",items:l},{region:"center",width:"45%",border:false,minWidth:200,maxSize:700,split:true,autoScroll:true,layout:"fit",floatable:true,items:E}]});
javafree.CenterPanel.addCmp(j);});