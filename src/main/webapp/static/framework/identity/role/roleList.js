Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var o=50;var u=javafree.CONTEXTPATH+"/identity/membership/doGetMembershipGridJson";
var y=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"principal",type:"string"},{name:"role_id",type:"string"},{name:"department_id",type:"string"},{name:"user_id",type:"string"},{name:"sn",type:"int"}],pageSize:o,proxy:{type:"jsonp",enablePaging:true,url:u,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,remoteGroup:false,sorters:{property:"department_id",direction:"ASC"},groupField:"department_id"});
var p=javafree.CONTEXTPATH+"/identity/role/doGetRoleGridJson";var i=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"orgcode",type:"string"},{name:"scopetype",type:"string"},{name:"createDate",type:"string"},{name:"sn",type:"int"}],pageSize:o,proxy:{type:"jsonp",enablePaging:true,url:p,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:true,remoteSort:true,groupField:"note",sorters:{property:"note",direction:"DESC"}});
var d=[{width:160,fieldLabel:"查询",emptyText:"角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:i},{pressed:false,icon:ICONPATH+"button/add.png",cls:"x-btn-text-icon",text:"新增",handler:function(){q.add_btn_fn();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit.png",text:"编辑",handler:function(){q.edit_btn_fn();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除",handler:function(){q.delete_btn_fn();}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/group_add.png",text:"添加角色成员",handler:function(){x();
}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/arrow-up.png",text:"上移",handler:function(){a();}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/arrow-down.png",text:"下移",handler:function(){c();}},{pressed:false,xtype:"splitbutton",cls:"x-btn-text-icon",icon:ICONPATH+"button/menu-show.png",text:"更多操作",menu:[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/reset-sort-order.png",text:"重排序号",handler:function(){f();
}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/edit-list-order.png",text:"设置序号",handler:function(){v();}}]}];function x(){var F=g.getSelectionModel().getSelection();if(F.length>0){var I=[];for(var H=0,E=F.length;H<E;H++){I.push(F[H].get("id"));}var G=javafree.CONTEXTPATH+"/identity/role/doGetSelectRoleMemberList?parentWinGridPanelID="+D.getId()+"&current_roleids="+I.toString();
javafree.CenterPanel.popupWindow(G,"为角色添加成员：",1000,580);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请先选择角色列表数据!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}var q={add_btn_fn:function(F){var E=javafree.CONTEXTPATH+"/identity/role/doGetRole?parentWinGridPanelID="+g.getId();javafree.CenterPanel.popupWindow(E,"新增角色信息");
},edit_btn_fn:function(G){var E=g.getSelectionModel().getSelection();if(E.length>0){if(E.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var F=javafree.CONTEXTPATH+"/identity/role/doGetRole?id="+E[0].get("id")+"&parentWinGridPanelID="+g.getId();
javafree.CenterPanel.popupWindow(F,"编辑角色信息");}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},delete_btn_fn:function(F){var E=g.getSelectionModel().getSelection();if(E.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",q.delete_btn_fn_detail);
}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}},delete_btn_fn_detail:function(J){if(J=="yes"){var F=g.getSelectionModel().getSelection();var I=[];var K=[];for(var H=0,E=F.length;H<E;H++){I.push(F[H].get("id"));K.push(F[H].get("orgcode"));
}var G=javafree.CONTEXTPATH+"/identity/role/doDelRole";Ext.Ajax.request({url:G,method:"GET",scope:this,params:{"IDS":I.toString(),"ORGCODES":K.toString()},success:function(L){var M=Ext.JSON.decode(L.responseText);if(M.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:M.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){i.reload();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:M.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(L){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}};function h(E,F){Ext.Ajax.request({url:E,method:"GET",scope:this,success:function(G){var H=Ext.JSON.decode(G.responseText);
if(H.success==true){if(F){Ext.MessageBox.alert({title:"提示信息:",msg:H.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){return true;}});}else{return true;}}else{Ext.MessageBox.show({title:"错误提示:",msg:H.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(G){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}function r(J){var F=g;var M=F.getStore();var L=javafree.CONTEXTPATH+"/identity/role/doSetDrag";var T=F.getSelectionModel().getSelection();if(T.length>0){if(T.length>1){Ext.MessageBox.show({title:"提示：",msg:"每次只能移动一行数据！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}else{var E=T[0].get("id");
var H=M.getById(E);var N=M.indexOf(H);if(("above"==J)&&(N>0)){var Q=N-1;var O=M.getAt(Q);var S=O.get("id");var V=O.get("sn");var G=H.get("sn");G=G<2?2:G;V=V<1?1:V;if(V==G){G=V+1;}H.set("sn",V);O.set("sn",G);M.removeAt(N);M.insert(N-1,H);F.getSelectionModel().select(H);var I=L+"?type=above&dropNodeId="+E+"&targetId="+S;
h(I,false);}if(("below"==J)&&(N<M.getCount()-1)){var P=N+1;var R=M.getAt(P);var K=R.get("id");var G=H.get("sn");var U=R.get("sn");G=G<1?1:G;U=U<2?2:U;if(G==U){U=G+1;}H.set("sn",U);R.set("sn",G);M.removeAt(N);M.insert(N+1,H);F.getSelectionModel().select(H);var I=L+"?type=below&dropNodeId="+E+"&targetId="+K;
h(I,false);}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要移动的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function a(){r("above");}function c(){r("below");}function v(){var F=g.getSelectionModel().getSelection();if(F.length>0){if(F.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能编辑一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var E=F[0];Ext.MessageBox.show({title:"设置用户序号...",msg:'用户：" '+E.get("name")+' "当前序号为："'+E.get("sn")+'" <br />   请输入新的序号...',buttonText:{ok:"确定",cancel:"取消"},prompt:true,value:E.get("sn"),fn:w,icon:Ext.MessageBox.INFO});}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}}function f(){Ext.MessageBox.show({title:"设置当前列表顺序号！",msg:'重排当前列表顺序号，<br />请指定序号起始值，默认为"1"',buttonText:{yes:"确定",cancel:"取消"},prompt:true,fn:w,value:1,icon:Ext.MessageBox.QUESTION});}function w(G,K){if(G=="yes"||G=="ok"){if(!(K.length>0&&(Math.round(K)==K))){Ext.MessageBox.show({title:"错误提示:",msg:'序号"'+K+'"格式错识，请输入整型数字！',buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
return;}var F=javafree.CONTEXTPATH+"/identity/role/doSetOrder?order="+Math.round(K);if(G=="yes"){var J=F+"&type=root";s(J);}else{var E=g.getSelectionModel().getSelection();if(E.length>0){if(E.length>1){Ext.MessageBox.show({title:"提示",msg:"每次只能选择一条记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}else{var H=E[0];var I=H.get("id");if(G=="ok"){var J=F+"&type=setorder&nodeId="+I;s(J);}}}else{Ext.MessageBox.show({title:"提示",msg:"请选择要编辑的记录！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}}}function s(E){Ext.Ajax.request({url:E,method:"GET",scope:this,success:function(F){var G=Ext.JSON.decode(F.responseText);
if(G.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:G.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){g.store.load();}});}else{Ext.MessageBox.show({title:"错误提示:",msg:G.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(F){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});
}});}var b=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function k(F,G,E){if(F=="PUBLIC"){return"公共";}else{return"私有";}}var g=Ext.create("Ext.grid.Panel",{title:"",tbar:d,selModel:b,multiSelect:true,forceFit:true,store:i,viewConfig:{enableTextSelection:true},selType:"cellmodel",plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:4})],features:[{id:"group",ftype:"grouping",groupHeaderTpl:'<font style="font-weight:bold" color="#00008b">{name}</font><font color="red"> ({rows.length})</font>'}],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"角色名称",dataIndex:"name",width:200},{header:"机构编码",width:120,sortable:true,dataIndex:"orgcode"},{header:"最近修改时间",width:150,sortable:true,align:"center",dataIndex:"createDate"},{header:"适用范围",width:100,sortable:true,align:"center",renderer:k,dataIndex:"scopetype"},{header:"次序号",dataIndex:"sn",sortable:true,align:"center",width:80,editor:{xtype:"numberfield",allowBlank:false,minValue:0,maxValue:100000}}],listeners:{"itemclick":function(F,E,I,G,J,H){Ext.apply(y.proxy.extraParams,{"roleid":E.data.id});
y.load({params:{start:0,limit:o}});D.setTitle(E.data.name+"-成员列表：");}},bbar:{xtype:"pagingtoolbar",store:i,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});g.on("edit",n,this);function n(){var E="",H="";var F=g.getSelectionModel().getSelection();if(F.length>0){E=F[0].get("id");H=F[0].get("sn");
var G=javafree.CONTEXTPATH+"/identity/role/doEditRoleSn";Ext.Ajax.request({url:G,method:"POST",scope:this,params:{"ID":E,"SN":H,},success:function(I){var J=Ext.JSON.decode(I.responseText);if(J.success==true){}else{Ext.MessageBox.show({title:"错误提示:",msg:J.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});
}},failure:function(I){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}var m=[{width:220,fieldLabel:"查询",emptyText:"用户/角色/机构名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:y},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"删除成员",handler:function(){t();
}}];function t(){var E=D.getSelectionModel().getSelection();if(E.length>0){Ext.MessageBox.confirm("提示信息:","您确定要删除选中的数据吗?",z);}else{Ext.MessageBox.show({title:"错误提示:",msg:"请您选中要删除的行!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}}function z(J){if(J=="yes"){var F=D.getSelectionModel().getSelection();
var I=[];for(var H=0,E=F.length;H<E;H++){I.push(F[H].get("id"));}var G=javafree.CONTEXTPATH+"/identity/membership/doDelMembership";Ext.Ajax.request({url:G,method:"POST",scope:this,params:{"IDS":I.toString()},success:function(K){var L=Ext.JSON.decode(K.responseText);if(L.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:L.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){y.reload();
}});}else{Ext.MessageBox.show({title:"错误提示:",msg:L.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}},failure:function(K){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING});}});}}var l=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});
function e(F,G,E){if(F=="Y"){return"是";}else{return"否";}}function C(F,G,E){if(F!=""){var H=F.split("|");if(H.length>2){return H[1];}else{return F;}}else{return"";}}function j(F,G,E){if(F!=""){var H=F.split("|");if(H.length>2){return H[0];}else{return F;}}else{return"";}}var B="成员列表：";var D=Ext.create("Ext.grid.Panel",{title:B,tbar:m,selModel:l,multiSelect:true,forceFit:true,store:y,viewConfig:{enableTextSelection:true},features:[{id:"group",ftype:"grouping",groupHeaderTpl:'本部门成员：<font color="red"> ({rows.length})</font>'}],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"name",renderer:j,width:150},{header:"机构(部门)名称",dataIndex:"name",renderer:C,width:150},{header:"主要身份",dataIndex:"principal",width:80,align:"center",hidden:true,renderer:e},{header:"机构编码",dataIndex:"orgcode",width:100},{header:"次序号",dataIndex:"sn",width:70,hidden:true}],bbar:{xtype:"pagingtoolbar",store:y,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});
var A=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderBottom:"1px solid #cecece"},items:[{region:"west",title:"",split:true,width:"60%",border:false,minWidth:400,maxSize:800,autoScroll:true,layout:"fit",items:g},{region:"center",width:"40%",border:false,minWidth:300,maxSize:700,split:true,autoScroll:true,layout:"fit",floatable:true,items:D}]});
javafree.CenterPanel.addCmp(A);});