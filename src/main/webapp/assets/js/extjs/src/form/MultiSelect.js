Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.FieldContainer",mixins:["Ext.util.StoreHolder","Ext.form.field.Field"],alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselectfield","widget.multiselect"],requires:["Ext.panel.Panel","Ext.view.BoundList","Ext.layout.container.Fit"],uses:["Ext.view.DragZone","Ext.view.DropZone"],layout:"anchor",ddReorder:false,appendOnly:false,displayField:"text",allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) required",delimiter:",",dragText:"{0} Item{1}",ignoreSelectChange:0,pageSize:10,initComponent:function(){var a=this;
a.items=a.setupItems();a.bindStore(a.store,true);a.callParent();a.initField();},setupItems:function(){var a=this;a.boundList=new Ext.view.BoundList(Ext.apply({anchor:"none 100%",border:1,multiSelect:true,store:a.store,displayField:a.displayField,disabled:a.disabled,tabIndex:0,navigationModel:{type:"default"}},a.listConfig));
a.boundList.getNavigationModel().addKeyBindings({pageUp:a.onKeyPageUp,pageDown:a.onKeyPageDown,scope:a});a.boundList.getSelectionModel().on("selectionchange",a.onSelectChange,a);a.boundList.pickerField=a;if(!a.title){return a.boundList;}a.boundList.border=false;return{xtype:"panel",isAriaRegion:false,border:true,anchor:"none 100%",layout:"anchor",title:a.title,tbar:a.tbar,items:a.boundList};
},onSelectChange:function(a,b){if(!this.ignoreSelectChange){this.setValue(b);}},getSelected:function(){return this.boundList.getSelectionModel().getSelection();},isEqual:function(e,d){var b=Ext.Array.from,c=0,a;e=b(e);d=b(d);a=e.length;if(a!==d.length){return false;}for(;c<a;c++){if(d[c]!==e[c]){return false;
}}return true;},afterRender:function(){var d=this,c=d.boundList,b,a;d.callParent();if(d.selectOnRender){b=d.getRecordsForValue(d.value);if(b.length){++d.ignoreSelectChange;d.boundList.getSelectionModel().select(b);--d.ignoreSelectChange;}delete d.toSelect;}if(d.ddReorder&&!d.dragGroup&&!d.dropGroup){d.dragGroup=d.dropGroup="MultiselectDD-"+Ext.id();
}if(d.draggable||d.dragGroup){d.dragZone=Ext.create("Ext.view.DragZone",{view:d.boundList,ddGroup:d.dragGroup,dragText:d.dragText});}if(d.droppable||d.dropGroup){d.dropZone=Ext.create("Ext.view.DropZone",{view:d.boundList,ddGroup:d.dropGroup,handleNodeDrop:function(k,j,e){var f=this.view,h=f.getStore(),g=k.records,i;
k.view.store.remove(g);i=h.indexOf(j);if(e==="after"){i++;}h.insert(i,g);f.getSelectionModel().select(g);d.fireEvent("drop",d,g);}});}a=d.down("panel");if(a&&c){c.ariaEl.dom.setAttribute("aria-labelledby",a.header.id+"-title-textEl");}},onKeyPageUp:function(h){var g=this,b=g.pageSize,c=g.boundList,a=c.getNavigationModel(),d,f;
d=a.recordIndex;f=d>b?d-b:0;a.setPosition(f,h);},onKeyPageDown:function(i){var h=this,b=h.pageSize,c=h.boundList,a=c.getNavigationModel(),g,d,f;g=c.getStore().getCount();d=a.recordIndex;f=d<(g-b)?d+b:g-1;a.setPosition(f,i);},isValid:function(){var b=this,a=b.disabled,c=b.forceValidation||!a;return c?b.validateValue(b.value):a;
},validateValue:function(b){var a=this,d=a.getErrors(b),c=Ext.isEmpty(d);if(!a.preventMark){if(c){a.clearInvalid();}else{a.markInvalid(d);}}return c;},markInvalid:function(c){var b=this,a=b.getActiveError();b.setActiveErrors(Ext.Array.from(c));if(a!==b.getActiveError()){b.updateLayout();}},clearInvalid:function(){var b=this,a=b.hasActiveError();
b.unsetActiveError();if(a){b.updateLayout();}},getSubmitData:function(){var a=this,b=null,c;if(!a.disabled&&a.submitValue&&!a.isFileUpload()){c=a.getSubmitValue();if(c!==null){b={};b[a.getName()]=c;}}return b;},getSubmitValue:function(){var b=this,a=b.delimiter,c=b.getValue();return Ext.isString(a)?c.join(a):c;
},getValue:function(){return this.value||[];},getRecordsForValue:function(g){var f=this,a=[],h=f.store.getRange(),l=f.valueField,d=0,k=h.length,b,c,e;for(e=g.length;d<e;++d){for(c=0;c<k;++c){b=h[c];if(b.get(l)==g[d]){a.push(b);}}}return a;},setupValue:function(g){var b=this.delimiter,d=this.valueField,e=0,c,a,f;
if(Ext.isDefined(g)){if(b&&Ext.isString(g)){g=g.split(b);}else{if(!Ext.isArray(g)){g=[g];}}for(a=g.length;e<a;++e){f=g[e];if(f&&f.isModel){g[e]=f.get(d);}}c=Ext.Array.unique(g);}else{c=[];}return c;},setValue:function(d){var c=this,b=c.boundList.getSelectionModel(),a=c.store;if(!a.getCount()){a.on({load:Ext.Function.bind(c.setValue,c,[d]),single:true});
return;}d=c.setupValue(d);c.mixins.field.setValue.call(c,d);if(c.rendered){++c.ignoreSelectChange;b.deselectAll();if(d.length){b.select(c.getRecordsForValue(d));}--c.ignoreSelectChange;}else{c.selectOnRender=true;}},clearValue:function(){this.setValue([]);},onEnable:function(){var a=this.boundList;this.callParent();
if(a){a.enable();}},onDisable:function(){var a=this.boundList;this.callParent();if(a){a.disable();}},getErrors:function(b){var a=this,c=Ext.String.format,e=[],d;b=Ext.Array.from(b||a.getValue());d=b.length;if(!a.allowBlank&&d<1){e.push(a.blankText);}if(d<a.minSelections){e.push(c(a.minSelectionsText,a.minSelections));
}if(d>a.maxSelections){e.push(c(a.maxSelectionsText,a.maxSelections));}return e;},doDestroy:function(){var a=this;a.bindStore(null);Ext.destroy(a.dragZone,a.dropZone,a.keyNav);a.callParent();},onBindStore:function(a){var c=this,b=this.boundList;if(a.autoCreated){c.resolveDisplayField();}if(!Ext.isDefined(c.valueField)){c.valueField=c.displayField;
}if(b){b.bindStore(a);}},resolveDisplayField:function(){var c=this,b=c.boundList,a=c.getStore();c.valueField=c.displayField="field1";if(!a.expanded){c.displayField="field2";}if(b){b.setDisplayField(c.displayField);}}});