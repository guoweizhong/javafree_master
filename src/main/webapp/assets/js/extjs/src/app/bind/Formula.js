Ext.define("Ext.app.bind.Formula",{extend:"Ext.util.Schedulable",requires:["Ext.util.LruCache"],statics:{getFormulaParser:function(b){var a=this.formulaCache,d,c;if(!a){a=this.formulaCache=new Ext.util.LruCache({maxSize:20});}d=a.get(b);if(!d){c="[^\\.a-z0-9_]"+Ext.String.escapeRegex(b)+"\\(\\s*(['\"])(.*?)\\1\\s*\\)";
d=new RegExp(c,"gi");a.add(b,d);}return d;}},isFormula:true,calculation:null,explicit:false,set:null,single:false,fnKeywordArgumentNamesRe:/^function\s*[^\(]*\(\s*([^,\)\s]+)/,fnKeywordRe:/^\s*function/,replaceParenRe:/[\(\)]/g,constructor:function(g,h){var f=this,b=g.owner,d,e,a,c;f.owner=b;f.stub=g;
f.callParent();if(h instanceof Function){f.get=a=h;}else{f.get=a=h.get;f.set=h.set;e=h.bind;if(h.single){f.single=h.single;}if(e){d=e.bindTo;if(d){c=Ext.apply({},e);delete c.bindTo;e=d;}}}if(!a){Ext.raise("Must specify a getter method for a formula");}if(e){f.explicit=true;}else{e=a.$expressions||f.parseFormula(a);
}f.binding=b.bind(e,f.onChange,f,c);},destroy:function(){var a=this,c=a.binding,b=a.stub;if(c){c.destroy();a.binding=null;}if(b){b.formula=null;}a.callParent();a.getterFn=a.owner=null;},getFullName:function(){return this.fullName||(this.fullName=this.stub.getFullName()+"="+this.callParent()+")");},getRawValue:function(){return this.calculation;
},onChange:function(){if(!this.scheduled){this.schedule();}},parseFormula:function(h){var g=Ext.Function.toCode(h),d="get",e={$literal:true},c,b,a,f;if(this.fnKeywordRe.test(g)){c=this.fnKeywordArgumentNamesRe.exec(g);if(c){b=c[1];}}else{c=g.split("=>")[0];if(c){c=Ext.String.trim(c.replace(this.replaceParenRe,"")).split(",");
b=c[0];}}b=b||d;a=Ext.app.bind.Formula.getFormulaParser(b);while((c=a.exec(g))){f=c[2];e[f]=f;}e.$literal=true;h.$expressions=e;return e;},react:function(){var c=this,b=c.owner,d=c.binding.lastValue,e=c.getterFn,a;if(c.explicit){a=d;}else{a=b.getFormulaFn(d);}c.settingValue=true;c.stub.set(c.calculation=c.get.call(b,a));
c.settingValue=false;if(c.single){c.destroy();}},setValue:function(a){this.set.call(this.stub.owner,a);},privates:{getScheduler:function(){var a=this.owner;return a&&a.getScheduler();},sort:function(){var a=this,b=a.binding;if(!b.destroyed){a.scheduler.sortItem(b);}}}});