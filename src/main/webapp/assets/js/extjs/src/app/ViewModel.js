Ext.define("Ext.app.ViewModel",{mixins:["Ext.mixin.Factoryable","Ext.mixin.Identifiable"],requires:["Ext.util.Scheduler","Ext.data.Session","Ext.app.bind.RootStub","Ext.app.bind.LinkStub","Ext.app.bind.Multi","Ext.app.bind.Formula","Ext.app.bind.TemplateBinding","Ext.data.ChainedStore"],alias:"viewmodel.default",isViewModel:true,factoryConfig:{name:"viewModel"},collectTimeout:100,expressionRe:/^(?:\{(?:(\d+)|([a-z_][\w\.]*))\})$/i,$configStrict:false,config:{data:true,formulas:{$value:null,merge:function(d,a,c,b){return this.mergeNew(d,a,c,b);
}},links:null,parent:null,root:true,scheduler:null,schema:"default",session:null,stores:null,view:null},constructor:function(a){this.bindings={};this.initConfig(a);},destroy:function(){var f=this,d=f._scheduler,j=f.storeInfo,h=f.getParent(),c=f.collectTask,b=f.children,a=f.bindings,i,g,e;f.destroying=true;
if(c){c.cancel();f.collectTask=null;}if(b){for(i in b){b[i].destroy();}}if(j){for(i in j){g=j[i];e=g.autoDestroy;if(e||(!g.$wasInstance&&e!==false)){g.destroy();}Ext.destroy(g.$binding);}}if(h){h.unregisterChild(f);}f.getRoot().destroy();for(i in a){a[i].destroy();}if(d&&d.$owner===f){d.$owner=null;d.destroy();
}f.children=f.storeInfo=f._session=f._view=f._scheduler=f.bindings=f._root=f._parent=f.formulaFn=f.$formulaData=null;f.destroying=false;f.callParent();},bind:function(e,g,c,b){var d=this,a=true,f;c=c||d;if(!b&&e.bindTo!==undefined&&!Ext.isString(e)){b=e;e=b.bindTo;}if(!Ext.isString(e)){f=new Ext.app.bind.Multi(e,d,g,c,b);
}else{if(d.expressionRe.test(e)){e=e.substring(1,e.length-1);f=d.bindExpression(e,g,c,b);a=false;}else{f=new Ext.app.bind.TemplateBinding(e,d,g,c,b);}}if(a){d.bindings[f.id]=f;}return f;},getSession:function(){var b=this,c=b._session,a;if(!c&&(a=b.getParent())){b.setSession(c=a.getSession());}return c||null;
},getStore:function(b){var c=this.storeInfo,a;if(c){a=c[b];}return a||null;},linkTo:function(i,d){var h=this,c,f,a,b,g,e;if(i.indexOf(".")>-1){Ext.raise('Links can only be at the top-level: "'+i+'"');}if(d.isModel){d={type:d.entityName,id:d.id};}b=d.type||d.reference;f=d.create;if(b){a=d.id;if(!d.create&&Ext.isEmpty(a)){Ext.raise('No id specified. To create a phantom model, specify "create: true" as part of the reference.');
}if(f){a=undefined;}e=h.getRecord(b,a);if(Ext.isObject(f)){e.set(f);e.commit();e.phantom=true;}c=h.getRoot().createStubChild(i);c.set(e);}else{c=h.getStub(i);if(!c.isLinkStub){g=new Ext.app.bind.LinkStub(h,c.name);c.graft(g);c=g;}c.link(d);}},notify:function(){var a=this.getScheduler();if(!a.firing){a.notify();
}},get:function(a){return this.getStub(a).getValue();},set:function(e,b){var a=this,d,c;a.getData();if(b===undefined&&e&&e.constructor===Object){c=a.getRoot();b=e;}else{if(e&&e.indexOf(".")<0){d={};d[e]=b;b=d;c=a.getRoot();}else{c=a.getStub(e);}}c.set(b);},privates:{registerChild:function(b){var a=this.children;
if(!a){this.children=a={};}a[b.getId()]=b;},unregisterChild:function(b){var a=this.children;if(!this.destroying&&a){delete a[b.getId()];}},getRecord:function(b,f){var d=this.getSession(),e=b,c=f!==undefined,a;if(d){if(c){a=d.getRecord(b,f);}else{a=d.createRecord(b);}}else{if(!e.$isClass){e=this.getSchema().getEntity(e);
if(!e){Ext.raise("Invalid model name: "+b);}}if(c){a=e.createWithId(f);a.load();}else{a=new e();}}return a;},bindExpression:function(d,e,b,a){var c=this.getStub(d);return c.bind(e,b,a);},applyScheduler:function(a){if(a&&!a.isInstance){if(a===true){a={};}if(!("preSort" in a)){a=Ext.apply({preSort:"kind,-depth"},a);
}a=new Ext.util.Scheduler(a);a.$owner=this;}return a;},getScheduler:function(){var c=this,a=c._scheduler,b;if(!a){if(!(b=c.getParent())){a=new Ext.util.Scheduler({preSort:"kind,-depth"});a.$owner=c;}else{a=b.getScheduler();}c.setScheduler(a);}return a;},getStub:function(b){var a=this.getRoot();return b?a.getChild(b):a;
},collect:function(){var c=this,b=c.getParent(),a=c.collectTask;if(b){b.collect();return;}if(!a){a=c.collectTask=new Ext.util.DelayedTask(c.doCollect,c);}if(c.collectTimeout===0){c.doCollect();}else{a.delay(c.collectTimeout);}},doCollect:function(){var b=this.children,a;if(b){for(a in b){b[a].doCollect();
}}this.getRoot().collect();},invalidateChildLinks:function(b,a){var d=this.children,c;if(d){for(c in d){d[c].getRoot().invalidateChildLink(b,a);}}},onBindDestroy:function(d,a){var c=this,b;if(c.destroying){return;}if(!a){delete c.bindings[d.id];}b=c.getParent();if(b){b.onBindDestroy(d,true);}else{c.collect();
}},applyData:function(c,e){var d=this,a,b;d.getSession();if(!e){b=d.getParent();d.linkData=a=b?Ext.Object.chain(b.getData()):{};d.data=d._data=Ext.Object.chain(a);}if(c&&c.constructor===Object){d.getRoot().set(c,true);}},applyParent:function(a){if(a){a.registerChild(this);}return a;},applyStores:function(c){var f=this,b=f.getRoot(),d,a,h,g,e;
f.storeInfo={};f.listenerScopeFn=function(){return f.getView().getInheritedConfig("defaultListenerScope");};for(d in c){a=c[d];if(a.isStore){a.$wasInstance=true;f.setupStore(a,d);continue;}else{if(Ext.isString(a)){a={source:a};}else{a=Ext.apply({},a);}}e=a.listeners;delete a.listeners;h=f.bind(a,f.onStoreBind,f,{trackStatics:true});
if(h.isStatic()){h.destroy();f.createStore(d,a,e);}else{h.$storeKey=d;h.$listeners=e;g=b.createStubChild(d);g.setStore(h);}}},onStoreBind:function(a,c,g){var f=this.storeInfo,e=g.$storeKey,b=f[e],d;if(!b){this.createStore(e,a,g.$listeners,g);}else{a=Ext.merge({},g.pruneStaticKeys());d=a.proxy;delete a.type;
delete a.model;delete a.fields;delete a.proxy;delete a.listeners;if(d){delete d.reader;delete d.writer;b.getProxy().setConfig(d);}b.setConfig(a);}},createStore:function(c,a,d,f){var e=this.getSession(),b;a=Ext.apply({},a);if(a.session){a.session=e;}if(a.source){a.type=a.type||"chained";}a.listeners=d;
a.resolveListenerScope=this.listenerScopeFn;b=Ext.Factory.store(a);b.$binding=f;this.setupStore(b,c);},setupStore:function(a,b){a.resolveListenerScope=this.listenerScopeFn;this.storeInfo[b]=a;this.set(b,a);},applyFormulas:function(c){var d=this,a=d.getRoot(),b,e;d.getData();for(b in c){if(b.indexOf(".")>=0){Ext.raise("Formula names cannot contain dots: "+b);
}a.createStubChild(b);e=d.getStub(b);e.setFormula(c[b]);}return c;},applyLinks:function(a){for(var b in a){this.linkTo(b,a[b]);}},applySchema:function(a){return Ext.data.schema.Schema.get(a);},applyRoot:function(){var a=new Ext.app.bind.RootStub(this),b=this.getParent();if(b){a.depth=b.getRoot().depth-1000;
}return a;},getFormulaFn:function(c){var b=this,a=b.formulaFn;if(!a){a=b.formulaFn=function(d){return b.$formulaData[d];};}b.$formulaData=c;return a;}}});