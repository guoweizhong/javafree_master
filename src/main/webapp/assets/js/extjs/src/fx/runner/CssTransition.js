Ext.define("Ext.fx.runner.CssTransition",{extend:"Ext.fx.runner.Css",requires:["Ext.AnimationQueue"],alternateClassName:"Ext.Animator",singleton:true,listenersAttached:false,constructor:function(){this.runningAnimationsData={};this.transitionQueue={toData:{},transitionData:{}};return this.callParent(arguments);
},attachListeners:function(){this.listenersAttached=true;Ext.getWin().on("transitionend","onTransitionEnd",this);},onTransitionEnd:function(b){var a=b.target,c=a.id;if(c&&this.runningAnimationsData.hasOwnProperty(c)){this.refreshRunningAnimationsData(Ext.get(a),[b.browserEvent.propertyName]);}},getElementId:function(a){return a.getId?a.getId():a.id;
},onAnimationEnd:function(g,f,d,j,n){var c=this.getElementId(g),k=this.runningAnimationsData[c],o={},m={},b,h,e,l,a;d.un("stop","onAnimationStop",this);if(k){b=k.nameMap;}o[c]=m;if(f.onBeforeEnd){f.onBeforeEnd.call(f.scope||this,g,j);}d.fireEvent("animationbeforeend",d,g,j);this.fireEvent("animationbeforeend",this,d,g,j);
if(n||(!j&&!f.preserveEndState)){h=f.toPropertyNames;for(e=0,l=h.length;e<l;e++){a=h[e];if(b&&!b.hasOwnProperty(a)){m[a]=null;}}}if(f.after){Ext.merge(m,f.after);}this.applyStyles(o);if(f.onEnd){f.onEnd.call(f.scope||this,g,j);}d.fireEvent("animationend",d,g,j);this.fireEvent("animationend",this,d,g,j);
Ext.AnimationQueue.stop(Ext.emptyFn,d);},onAllAnimationsEnd:function(b){var d=this.getElementId(b),c=this.transitionQueue,a={};delete this.runningAnimationsData[d];a[d]={"transition-property":null,"transition-duration":null,"transition-timing-function":null,"transition-delay":null};delete c.toData[d];
delete c.transitionData[d];this.applyStyles(a);this.fireEvent("animationallend",this,b);},hasRunningAnimations:function(a){var c=this.getElementId(a),b=this.runningAnimationsData;return b.hasOwnProperty(c)&&b[c].sessions.length>0;},refreshRunningAnimationsData:function(d,k,t,p){var g=this.getElementId(d),q=this.runningAnimationsData,a=q[g];
if(!a){return;}var m=a.nameMap,s=a.nameList,b=a.sessions,f,h,e,u,l,c,r,o,n=false;t=Boolean(t);p=Boolean(p);if(!b){return this;}f=b.length;if(f===0){return this;}if(p){a.nameMap={};s.length=0;for(l=0;l<f;l++){c=b[l];this.onAnimationEnd(d,c.data,c.animation,t,p);}b.length=0;}else{for(l=0;l<f;l++){c=b[l];
r=c.map;o=c.list;for(h=0,e=k.length;h<e;h++){u=k[h];if(r[u]){delete r[u];Ext.Array.remove(o,u);c.length--;if(--m[u]==0){delete m[u];Ext.Array.remove(s,u);}}}if(c.length==0){b.splice(l,1);l--;f--;n=true;this.onAnimationEnd(d,c.data,c.animation,t);}}}if(!p&&!t&&b.length==0&&n){this.onAllAnimationsEnd(d);
}},getRunningData:function(b){var a=this.runningAnimationsData;if(!a.hasOwnProperty(b)){a[b]={nameMap:{},nameList:[],sessions:[]};}return a[b];},getTestElement:function(){var c=this,d=c.testElement,b=c.iframe,e,a;if(d){if(d.ownerDocument.defaultView!==b.contentWindow){b.contentDocument.body.appendChild(d);
c.testElementComputedStyle=e.defaultView.getComputedStyle(d);}}else{b=c.iframe=document.createElement("iframe");b.setAttribute("data-sticky",true);b.setAttribute("tabIndex",-1);a=b.style;a.setProperty("visibility","hidden","important");a.setProperty("width","0px","important");a.setProperty("height","0px","important");
a.setProperty("position","absolute","important");a.setProperty("border","0px","important");a.setProperty("zIndex","-1000","important");document.body.appendChild(b);e=b.contentDocument;e.open();e.writeln("</body>");e.close();c.testElement=d=e.createElement("div");d.style.setProperty("position","absolute","important");
e.body.appendChild(d);c.testElementComputedStyle=e.defaultView.getComputedStyle(d);}return d;},getCssStyleValue:function(b,e){var d=this.getTestElement(),a=this.testElementComputedStyle,c=d.style;c.setProperty(b,e);if(Ext.browser.is.Firefox){d.offsetHeight;}e=a.getPropertyValue(b);c.removeProperty(b);
return e;},run:function(M){var q=this,v=Ext.Function,z=[],x=q.lengthProperties,w={},h=q.transitionQueue.toData,K={},E=q.transitionQueue.transitionData,l,a,m,N,B,L,u,p,e,c,b,I,H,y,O,J,C,t,o,g,k,r,G,s,n,f,F,D,d,A;if(!q.listenersAttached){q.attachListeners();}M=Ext.Array.from(M);for(I=0,y=M.length;I<y;I++){O=M[I];
O=Ext.factory(O,Ext.fx.Animation);z.push(O);q.activeElement=l=O.getElement();Ext.AnimationQueue.start(Ext.emptyFn,O);t=window.getComputedStyle(l.dom);a=q.getElementId(l);K[a]=K=Ext.merge({},O.getData());A=O.getOnBeforeStart();if(A){A.call(O.scope||q,l);}O.fireEvent("animationstart",O,K);q.fireEvent("animationstart",q,O,K);
B=K.before;m=K.from;N=K.to;K.fromPropertyNames=L=[];K.toPropertyNames=u=[];for(g in N){if(N.hasOwnProperty(g)){N[g]=k=q.formatValue(N[g],g);o=q.formatName(g);s=x.hasOwnProperty(g);if(!s){k=q.getCssStyleValue(o,k);}if(m.hasOwnProperty(g)){m[g]=G=q.formatValue(m[g],g);if(!s){G=q.getCssStyleValue(o,G);}if(k!==G){L.push(o);
u.push(o);}}else{r=t.getPropertyValue(o);if(k!==r){u.push(o);}}}}J=u.length;if(J===0){q.onAnimationEnd(l,K,O);continue;}c=q.getRunningData(a);F=c.sessions;if(F.length>0){q.refreshRunningAnimationsData(l,Ext.Array.merge(L,u),true,K.replacePrevious);}n=c.nameMap;f=c.nameList;C={};for(H=0;H<J;H++){g=u[H];
C[g]=true;if(!n.hasOwnProperty(g)){n[g]=1;f.push(g);}else{n[g]++;}}D={element:l,map:C,list:u.slice(),length:J,data:K,animation:O};F.push(D);O.on("stop","onAnimationStop",q);b=Ext.apply({},B);Ext.apply(b,m);if(f.length>0){L=Ext.Array.difference(f,L);u=Ext.Array.merge(L,u);b["transition-property"]=L;}w[a]=b;
h[a]=Ext.apply({},N);E[a]={"transition-property":u,"transition-duration":K.duration,"transition-timing-function":K.easing,"transition-delay":K.delay};O.startTime=Date.now();}q.activeElement=null;e=q.$className;q.applyStyles(w);p=function(i){if(i.data===e&&i.source===window){window.removeEventListener("message",p,false);
q.applyStyles(q.transitionQueue.toData);}};if(!q.messageTimerId){d=function(){var i;q.messageTimerId=null;if(Ext.isIE){q.applyStyles(q.transitionQueue.transitionData);if(!q.messageFollowupId){i=function(){q.messageFollowupId=null;window.addEventListener("message",p,false);window.postMessage(e,"*");};
i.$skipTimerCheck=true;q.messageFollowupId=v.requestAnimationFrame(i);}}else{Ext.merge(q.transitionQueue.toData,q.transitionQueue.transitionData);window.addEventListener("message",p,false);window.postMessage(e,"*");}};d.$skipTimerCheck=true;q.messageTimerId=v.requestAnimationFrame(d);}return z;},onAnimationStop:function(c){var h=this,b=h.runningAnimationsData,l=0,j=0,a,e,k,d,f,g;
for(a in b){if(b.hasOwnProperty(a)){e=b[a];k=e.sessions;l++;for(d=0,f=k.length;d<f;d++){g=k[d];if(g.animation===c){h.refreshRunningAnimationsData(g.element,g.list.slice(),false);if(c.destroying){j++;}}}}}if(l===j){if(h.messageFollowupId){clearTimeout(h.messageFollowupId);h.messageFollowupId=null;}if(h.messageTimerId){clearTimeout(h.messageTimerId);
h.messageTimerId=null;}Ext.apply(h.transitionQueue,{toData:{},transitionData:{}});}}});