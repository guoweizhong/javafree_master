Ext.define("Ext.event.publisher.Gesture",{extend:"Ext.event.publisher.Dom",requires:["Ext.util.Point","Ext.AnimationQueue"],uses:"Ext.event.gesture.*",type:"gesture",isCancelEvent:{touchcancel:1,pointercancel:1,MSPointerCancel:1},handledEvents:[],handledDomEvents:[],constructor:function(b){var f=this,c=f.handledDomEvents,a=Ext.supports,e=a.TouchEvents,g=f.onTouchStart,d=f.onTouchMove,h=f.onTouchEnd;
f.handlers={touchstart:g,touchmove:d,touchend:h,touchcancel:h,pointerdown:g,pointermove:d,pointerup:h,pointercancel:h,MSPointerDown:g,MSPointerMove:d,MSPointerUp:h,MSPointerCancel:h,mousedown:g,mousemove:d,mouseup:h};f.activeTouchesMap={};f.activeTouches=[];f.changedTouches=[];f.recognizers=[];f.eventToRecognizer={};
f.cancelEvents=[];if(e){f.onTargetTouchMove=f.onTargetTouchMove.bind(f);f.onTargetTouchEnd=f.onTargetTouchEnd.bind(f);}if(a.PointerEvents){c.push("pointerdown","pointermove","pointerup","pointercancel");f.mousePointerType="mouse";}else{if(a.MSPointerEvents){c.push("MSPointerDown","MSPointerMove","MSPointerUp","MSPointerCancel");
f.mousePointerType=4;}else{if(e){c.push("touchstart","touchmove","touchend","touchcancel");}}}if(!c.length||(e&&Ext.os.is.Desktop)){c.push("mousedown","mousemove","mouseup");}f.initConfig(b);return f.callParent();},onReady:function(){this.callParent();Ext.Array.sort(this.recognizers,function(f,e){var d=f.priority,c=e.priority;
return(d>c)?1:(d<c)?-1:0;});},registerRecognizer:function(a){var f=this,c=a.handledEvents,e=c.length,b,d;a.setOnRecognized(f.onRecognized);a.setCallbackScope(f);for(d=0;d<e;d++){b=c[d];f.handledEvents.push(b);f.eventToRecognizer[b]=a;}f.registerEvents(c);f.recognizers.push(a);},onRecognized:function(a,h,l,b,k){var o=this,g=l.touches,p=l.changedTouches,m=p.length,r=o.events,f=!r.length,n=o.cancelEvents,q,j,d,c;
b=b||{};b.type=h;b.target=p[0].target;b.stopped=false;b.claimed=false;b.isGesture=true;l=l.chain(b);if(!o.gestureTargets){if(m>1){q=[];for(d=0;d<m;d++){c=p[d];q.push(c.targets);}j=o.getCommonTargets(q);}else{j=p[0].targets;}o.gestureTargets=j;}if(k&&a.isSingleTouch&&(g.length>1)){l.target=g[0].target;
n.push(l);}else{r.push(l);}if(f){o.publishGestures();}},getCommonTargets:function(a){var h=a[0],f=a.length;if(f===1){return h;}var d=[],e=1,g,b,c;while(true){g=h[h.length-e];if(!g){return d;}for(c=1;c<f;c++){b=a[c];if(b[b.length-e]!==g){return d;}}d.unshift(g);e++;}return d;},invokeRecognizers:function(c,g){var b=this.recognizers,f=b.length,d,a;
if(c==="onStart"){for(d=0;d<f;d++){b[d].isActive=true;}}for(d=0;d<f;d++){a=b[d];if(a.isActive&&a[c].call(a,g)===false){a.isActive=false;}}},filterClaimed:function(j,c){var g=this,d=g.eventToRecognizer,h=c.type,a=d[h],k,b,f,e;for(e=j.length;e--;){f=j[e].type;if(f===h){k=e;}else{b=d[f];if(!a||(b&&(b!==a))){j.splice(e,1);
if(k){k--;}}}}g.claimRecognizer(a,j[0]);return k;},claimRecognizer:function(a,h){var g=this,c=g.recognizers,d,f,b;for(d=0,f=c.length;d<f;d++){b=c[d];if(b!==a){b.isActive=false;b.cancel(h);}}if(g.events.length){g.publishGestures(true);}},publishGestures:function(d){var c=this,e=c.cancelEvents,a=c.events,b=c.gestureTargets;
if(e.length){c.cancelEvents=[];c.publish(e,c.getPropagatingTargets(e[0].target),true);}if(a.length){c.events=[];c.gestureTargets=null;c.publish(a,b||c.getPropagatingTargets(a[0].target),d);}},updateTouches:function(j,b){var n=this,r=j.browserEvent,f=r.changedTouches||[r],a=n.activeTouches,k=n.activeTouchesMap,p=[],m,h,d,g,c,l,q,o;
for(c=0,l=f.length;c<l;c++){m=f[c];if("identifier" in m){h=m.identifier;}else{if("pointerId" in m){h=m.pointerId;}else{h=1;}}d=k[h];if(!d){g=Ext.event.Event.resolveTextNode(m.target);d=k[h]={identifier:h,target:g,targets:n.getPropagatingTargets(g)};a.push(d);}if(b){delete k[h];Ext.Array.remove(a,d);}q=m.pageX;
o=m.pageY;d.pageX=q;d.pageY=o;d.point=new Ext.util.Point(q,o);p.push(d);}j.touches=Ext.Array.clone(a);j.changedTouches=p;},publishDelegatedDomEvent:function(b){var a=this;if(!b.button||b.button<1){a.events=[b];a.handlers[b.type].call(a,b);}else{a.callParent([b]);}},onTouchStart:function(d){var a=this,c=d.target,b=d.browserEvent.touches;
if(d.browserEvent.type==="touchstart"){c.addEventListener("touchmove",a.onTargetTouchMove);c.addEventListener("touchend",a.onTargetTouchEnd);c.addEventListener("touchcancel",a.onTargetTouchEnd);}if(b&&b.length<=a.activeTouches.length){a.removeGhostTouches(b);}a.updateTouches(d);if(!a.isStarted){if(Ext.enableGarbageCollector){Ext.dom.GarbageCollector.pause();
}a.isStarted=true;a.invokeRecognizers("onStart",d);}a.invokeRecognizers("onTouchStart",d);a.publishGestures();},onTouchMove:function(c){var b=this,a=b.mousePointerType;if(b.isStarted){if(a&&c.browserEvent.pointerType===a&&c.buttons===0){c.type=Ext.dom.Element.prototype.eventMap.touchend;c.button=0;b.onTouchEnd(c);
return;}b.updateTouches(c);if(c.changedTouches.length>0){b.invokeRecognizers("onTouchMove",c);}}b.publishGestures();},onTouchEnd:function(c){var b=this,a;if(!b.isStarted){b.publishGestures();return;}b.updateTouches(c,true);a=b.activeTouches.length;try{b.invokeRecognizers(b.isCancelEvent[c.type]?"onTouchCancel":"onTouchEnd",c);
}finally{try{if(!a){b.isStarted=false;b.invokeRecognizers("onEnd",c);}}finally{try{b.publishGestures();}finally{if(!a){if(Ext.enableGarbageCollector){Ext.dom.GarbageCollector.resume();}}b.reEnterCountAdjusted=true;b.reEnterCount--;}}}},onTargetTouchMove:function(a){if(Ext.elevateFunction){Ext.elevateFunction(this.doTargetTouchMove,this,[a]);
}else{this.doTargetTouchMove(a);}},doTargetTouchMove:function(a){if(!Ext.getBody().contains(a.target)){this.onTouchMove(new Ext.event.Event(a));}},onTargetTouchEnd:function(a){if(Ext.elevateFunction){Ext.elevateFunction(this.doTargetTouchEnd,this,[a]);}else{this.doTargetTouchEnd(a);}},doTargetTouchEnd:function(c){var a=this,b=c.target;
b.removeEventListener("touchmove",a.onTargetTouchMove);b.removeEventListener("touchend",a.onTargetTouchEnd);b.removeEventListener("touchcancel",a.onTargetTouchEnd);if(!Ext.getBody().contains(b)){a.onTouchEnd(new Ext.event.Event(c));}},reset:function(){var e=this,b=e.recognizers,d=b.length,c,a;e.activeTouchesMap={};
e.activeTouches=[];e.changedTouches=[];e.isStarted=false;e.gestureTargets=null;e.events=[];e.cancelEvents=[];e.reEnterCount=0;for(c=0;c<d;c++){a=b[c];a.reset();a.isActive=false;}this.callParent();},privates:{removeGhostTouches:function(e){var c={},a=e.length,h=this.activeTouches,d=this.activeTouchesMap,b,g,f;
for(b=0;b<a;++b){c[e[b].identifier]=true;}b=h.length;while(b--){f=h[b];g=f.identifier;if(!e[g]){Ext.Array.remove(h,f);delete d[g];}}}}},function(a){a.instance=Ext.$gesturePublisher=new a();});