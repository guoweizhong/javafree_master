Ext.define("Ext.TaskQueue",{requires:"Ext.AnimationQueue",singleton:true,pending:false,mode:true,protectedReadQueue:[],protectedWriteQueue:[],readQueue:[],writeQueue:[],readRequestId:0,writeRequestId:0,timer:null,constructor:function(){this.run=Ext.Function.bind(this.run,this);this.runProtected=Ext.Function.bind(this.run,this,[this.protectedReadQueue,this.protectedWriteQueue,"runProtected"]);
this.runProtected.$skipTimerCheck=true;if(Ext.os.is.iOS){this.watch.$skipTimerCheck=true;Ext.interval(this.watch,500,this);}},requestRead:function(c,b,a){var d={id:++this.readRequestId,fn:c,scope:b,args:a};if(arguments[3]===true){this.protectedReadQueue.push(d);this.request(true,"runProtected");}else{this.readQueue.push(d);
this.request(true);}return d.id;},cancelRead:function(a){this.cancelRequest(this.readQueue,a,true);},requestWrite:function(c,b,a){var d={id:++this.writeRequestId,fn:c,scope:b,args:a};if(arguments[3]===true){this.protectedWriteQueue.push(d);this.request(false,"runProtected");}else{this.writeQueue.push(d);
this.request(false);}return d.id;},cancelWrite:function(a){this.cancelRequest(this.writeQueue,a,false);},request:function(b,c){var a=this;if(!a.pending){a.pendingTime=Date.now();a.pending=true;a.mode=b;if(b){a.timer=Ext.defer(a[c]||a.run,1);}else{a.timer=Ext.Function.requestAnimationFrame(a[c]||a.run);
}}if(a.mode===b&&a.timer){clearTimeout(a.timer);if(b){a.timer=Ext.defer(a[c]||a.run,1);}else{a.timer=Ext.Function.requestAnimationFrame(a[c]||a.run);}}},cancelRequest:function(a,d,c){for(var b=0;b<a.length;b++){if(a[b].id===d){a.splice(b,1);break;}}if(!a.length&&this.mode===c&&this.timer){clearTimeout(this.timer);
}},watch:function(){if(this.pending&&Date.now()-this.pendingTime>=500){this.run();}},run:function(m,f,a){var k=this,e=null,g,c,b,l,n,j,d,h;m=m||k.readQueue;f=f||k.writeQueue;k.pending=false;k.pending=k.timer=false;if(k.mode){g=m;if(f.length>0){e=false;}}else{g=f;if(m.length>0){e=true;}}c=g.slice();g.length=0;
for(d=0,h=c.length;d<h;d++){b=c[d];l=b.fn;n=b.scope;j=b.args;if(n&&(n.destroying||n.destroyed)){continue;}if(typeof l==="string"){l=n[l];}if(j){l.apply(n,j);}else{l.call(n);}}c.length=0;if(e!==null){k.request(e,a);}},clear:function(){var a=this,b=a.timer;a.readQueue.length=a.writeQueue.length=0;a.pending=a.timer=false;
a.mode=true;if(b){clearTimeout(b);Ext.Function.cancelAnimationFrame(b);}},privates:{flush:function(){var a=this;while(a.readQueue.length||a.writeQueue.length){clearTimeout(a.timer);Ext.Function.cancelAnimationFrame(a.timer);a.run();}a.mode=true;}}});