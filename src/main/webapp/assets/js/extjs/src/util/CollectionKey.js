Ext.define("Ext.util.CollectionKey",{mixins:["Ext.mixin.Identifiable"],isCollectionKey:true,observerPriority:-200,config:{collection:null,keyFn:null,property:null,rootProperty:null,unique:true},generation:0,map:null,mapRebuilds:0,constructor:function(a){this.initConfig(a);if(!Ext.isFunction(this.getKey)){Ext.raise("CollectionKey requires a keyFn or property config");
}},get:function(a){var b=this.map||this.getMap();return b[a]||null;},clear:function(){this.map=null;},getRootProperty:function(){var b=this,a=this.callParent();return a!==null?a:b.getCollection().getRootProperty();},indexOf:function(j,e){var a=this.map||this.getMap(),k=a[j],f=this.getCollection(),b=f.length,d,g,h,c;
if(!k){return -1;}if(e===undefined){e=-1;}if(k instanceof Array){h=k;g=b;for(c=h.length;c-->0;){d=f.indexOf(h[c]);if(d<g&&d>e){g=d;}}if(g===b){return -1;}}else{g=f.indexOf(k);}return(g>e)?g:-1;},updateKey:function(c,e){var b=this,d=b.map,f,a;if(d){f=d[e];if(f instanceof Array){a=Ext.Array.indexOf(f,c);
if(a>=0){if(f.length>2){f.splice(a,1);}else{d[e]=f[1-a];}}}else{if(f){if(b.getUnique()&&f!==c){Ext.raise('Incorrect oldKey "'+e+'" for item with newKey "'+b.getKey(c)+'"');}delete d[e];}}b.add([c]);}},onCollectionAdd:function(b,a){if(this.map){this.add(a.items);}},onCollectionItemChange:function(b,a){this.map=null;
},onCollectionRefresh:function(){this.map=null;},onCollectionRemove:function(e,d){var g=this,a=g.map,f=d.items,b=f.length,c,j,h;if(a){if(g.getUnique()&&b<e.length/2){for(c=0;c<b;++c){h=g.getKey(j=f[c]);delete a[h];}}else{g.map=null;}}},add:function(f){var g=this,a=g.map,b,e,j,h,c,d;c=f.length;d=g.getUnique();
for(e=0;e<c;++e){h=g.getKey(j=f[e]);if(d||!(h in a)){a[h]=j;}else{if(!((b=a[h]) instanceof Array)){a[h]=b=[b];}b.push(j);}}},applyKeyFn:function(a){if(Ext.isString(a)){this.getKey=function(b){return b[a]();};}else{this.getKey=a;}},updateProperty:function(b){var a=this.getRootProperty();this.getKey=function(c){return(a?c[a]:c)[b];
};},getMap:function(){var a=this,b=a.map;if(!b){a.map=b={};a.keysByItemKey={};++a.mapRebuilds;a.add(a.getCollection().items);}return b;},updateCollection:function(a,b){if(a){a.addObserver(this);}if(b){b.removeObserver(this);}},clone:function(){return new Ext.util.CollectionKey(this.getCurrentConfig());
},destroy:function(){this.clear();this.getCollection().removeObserver(this);this.destroyed=true;}});