Ext.define("Ext.data.request.Ajax",{extend:"Ext.data.request.Base",alias:"request.ajax",requires:["Ext.data.flash.BinaryXhr"],statics:{parseStatus:function(b,c){var a;if(c){if(c.responseType==="arraybuffer"){a=c.byteLength;}else{if(c.responseText){a=c.responseText.length;}}}b=b==1223?204:b;var e=(b>=200&&b<300)||b==304||(b==0&&Ext.isNumber(a)),d=false;
if(!e){switch(b){case 12002:case 12029:case 12030:case 12031:case 12152:case 13030:d=true;break;}}return{success:e,isException:d};}},start:function(e){var c=this,b=c.options,a=c.requestOptions,d=c.isXdr,g,f;g=c.xhr=c.openRequest(b,a,c.async,c.username,c.password);if(!d){f=c.setupHeaders(g,b,a.data,a.params);
}if(c.async){if(!d){g.onreadystatechange=Ext.Function.bind(c.onStateChange,c);}}if(d){c.processXdrRequest(c,g);}c.callParent([e]);g.send(e);if(!c.async){return c.onComplete();}return c;},abort:function(b){var a=this,d=a.xhr;if(b||a.isLoading()){try{d.onreadystatechange=null;}catch(c){d.onreadystatechange=Ext.emptyFn;
}d.abort();a.callParent([b]);a.onComplete();a.cleanup();}},cleanup:function(){this.xhr=null;delete this.xhr;},isLoading:function(){var a=this,d=a.xhr,b=d&&d.readyState,c=Ext.data.flash&&Ext.data.flash.BinaryXhr;if(!d||a.aborted||a.timedout){return false;}if(c&&d instanceof c){return b!==4;}return b!==0&&b!==4;
},openRequest:function(c,a,d,g,b){var e=this,f=e.newRequest(c);if(g){f.open(a.method,a.url,d,g,b);}else{if(e.isXdr){f.open(a.method,a.url);}else{f.open(a.method,a.url,d);}}if(c.binary||e.binary){if(window.Uint8Array){f.responseType="arraybuffer";}else{if(f.overrideMimeType){f.overrideMimeType("text/plain; charset=x-user-defined");
}else{if(!Ext.isIE){Ext.log.warn("Your browser does not support loading binary data using Ajax.");}}}}if(c.withCredentials||e.withCredentials){f.withCredentials=true;}return f;},newRequest:function(a){var b=this,c;if(a.binaryData){if(window.Uint8Array){c=b.getXhrInstance();}else{c=new Ext.data.flash.BinaryXhr();
}}else{if(b.cors&&Ext.isIE9m){c=b.getXdrInstance();b.isXdr=true;}else{c=b.getXhrInstance();b.isXdr=false;}}return c;},setupHeaders:function(n,o,f,d){var j=this,b=Ext.apply({},o.headers||{},j.defaultHeaders),m=j.defaultPostHeader,k=o.jsonData,a=o.xmlData,i="Content-Type",c=j.useDefaultXhrHeader,l,g;if(!b.hasOwnProperty(i)&&(f||d)){if(f){if(o.rawData){m="text/plain";
}else{if(a&&Ext.isDefined(a)){m="text/xml";}else{if(k&&Ext.isDefined(k)){m="application/json";}}}}b[i]=m;}if(c&&!b["X-Requested-With"]){b["X-Requested-With"]=j.defaultXhrHeader;}if(b[i]===undefined||b[i]===null){delete b[i];}try{for(l in b){if(b.hasOwnProperty(l)){g=b[l];n.setRequestHeader(l,g);}}}catch(h){j.owner.fireEvent("exception",l,g);
}return b;},getXdrInstance:function(){var a;if(Ext.ieVersion>=8){a=new XDomainRequest();}else{Ext.raise({msg:"Your browser does not support CORS"});}return a;},getXhrInstance:(function(){var b=[function(){return new XMLHttpRequest();},function(){return new ActiveXObject("MSXML2.XMLHTTP.3.0");},function(){return new ActiveXObject("MSXML2.XMLHTTP");
},function(){return new ActiveXObject("Microsoft.XMLHTTP");}],c=0,a=b.length,f;for(;c<a;++c){try{f=b[c];f();break;}catch(d){}}return f;}()),processXdrRequest:function(b,c){var a=this;delete b.headers;b.contentType=b.options.contentType||a.defaultXdrContentType;c.onload=Ext.Function.bind(a.onStateChange,a,[true]);
c.onerror=c.ontimeout=Ext.Function.bind(a.onStateChange,a,[false]);},processXdrResponse:function(a,b){a.getAllResponseHeaders=function(){return[];};a.getResponseHeader=function(){return"";};a.contentType=b.contentType||this.defaultXdrContentType;},onStateChange:function(b){var c=this,d=c.xhr,a=Ext.GlobalEvents;
if((d&&d.readyState==4)||c.isXdr){c.clearTimer();c.onComplete(b);c.cleanup();if(a.hasListeners.idle){a.fireEvent("idle");}}},onComplete:function(i){var f=this,a=f.owner,j=f.options,h=f.xhr,b={success:false,isException:false},k,g,c;if(!h||f.destroyed){return f.result=b;}try{k=Ext.data.request.Ajax.parseStatus(h.status,h);
if(k.success){k.success=h.readyState===4;}}catch(d){k=b;}g=f.success=f.isXdr?i:k.success;if(g){c=f.createResponse(h);if(a.hasListeners.requestcomplete){a.fireEvent("requestcomplete",a,c,j);}if(j.success){Ext.callback(j.success,j.scope,[c,j]);}}else{if(k.isException||f.aborted||f.timedout){c=f.createException(h);
}else{c=f.createResponse(h);}if(a.hasListeners.requestexception){a.fireEvent("requestexception",a,c,j);}if(j.failure){Ext.callback(j.failure,j.scope,[c,j]);}}f.result=c;if(j.callback){Ext.callback(j.callback,j.scope,[j,g,c]);}a.onRequestComplete(f);f.callParent([i]);return c;},createResponse:function(i){var g=this,c=g.isXdr,b={},j=c?[]:i.getAllResponseHeaders().replace(/\r\n/g,"\n").split("\n"),e=j.length,k,f,h,d,a;
while(e--){k=j[e];f=k.indexOf(":");if(f>=0){h=k.substr(0,f).toLowerCase();if(k.charAt(f+1)==" "){++f;}b[h]=k.substr(f+1);}}d={request:g,requestId:g.id,status:i.status,statusText:i.statusText,getResponseHeader:function(l){return b[l.toLowerCase()];},getAllResponseHeaders:function(){return b;}};if(c){g.processXdrResponse(d,i);
}if(g.binary){d.responseBytes=g.getByteArray(i);}else{d.responseText=i.responseText;d.responseXML=i.responseXML;}return d;},destroy:function(){this.xhr=null;this.callParent();},privates:{getByteArray:function(j){var c=j.response,b=j.responseBody,k=Ext.data.flash&&Ext.data.flash.BinaryXhr,a,h,f,d;if(j instanceof k){a=j.responseBytes;
}else{if(window.Uint8Array){a=c?new Uint8Array(c):[];}else{if(Ext.isIE9p){try{a=new VBArray(b).toArray();}catch(g){a=[];}}else{if(Ext.isIE){if(!this.self.vbScriptInjected){this.injectVBScript();}getIEByteArray(j.responseBody,a=[]);}else{a=[];h=j.responseText;f=h.length;for(d=0;d<f;d++){a.push(h.charCodeAt(d)&255);
}}}}}return a;},injectVBScript:function(){var a=document.createElement("script");a.type="text/vbscript";a.text=["Function getIEByteArray(byteArray, out)","Dim len, i","len = LenB(byteArray)","For i = 1 to len","out.push(AscB(MidB(byteArray, i, 1)))","Next","End Function"].join("\n");Ext.getHead().dom.appendChild(a);
this.self.vbScriptInjected=true;}}});