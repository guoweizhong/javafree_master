Ext.define("Ext.data.proxy.WebStorage",{extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.WebStorageProxy",requires:["Ext.data.identifier.Sequential"],config:{id:undefined},constructor:function(a){this.callParent(arguments);this.cache={};if(this.getStorageObject()===undefined){Ext.raise("Local Storage is not supported in this browser, please use another type of data proxy");
}if(this.getId()===undefined){Ext.raise("No unique id was provided to the local storage proxy. See Ext.data.proxy.LocalStorage documentation for details");}this.initialize();},create:function(e){var j=this,d=e.getRecords(),c=d.length,a=j.getIds(),b,g,f,h;if(j.isHierarchical===undefined){j.isHierarchical=!!d[0].isNode;
if(j.isHierarchical){j.getStorageObject().setItem(j.getTreeKey(),true);}}for(f=0;f<c;f++){g=d[f];if(g.phantom){g.phantom=false;h=g.identifier;if(h&&h.isUnique){b=g.getId();}else{b=j.getNextId();}}else{b=g.getId();}j.setRecord(g,b);g.commit();a.push(b);}j.setIds(a);e.setSuccessful(true);},read:function(h){var u=this,t,q=[],d=true,g=u.getModel(),e=0,s=h.getRecordCreator(),f,a,r,m,l,b,n,c,v,k,p,o;
if(u.isHierarchical){q=u.getTreeData();}else{n=u.getIds();c=n.length;k=h.getId();if(k){v=u.getRecord(k);if(v!==null){b=s?s(v,g):new g(v);}if(b){q.push(b);}else{d=false;}}else{a=h.getSorters();f=h.getFilters();r=h.getLimit();t=[];for(p=0;p<c;p++){v=u.getRecord(n[p]);b=s?s(v,g):new g(v);t.push(b);}if(a){Ext.Array.sort(t,Ext.util.Sorter.createComparator(a));
}for(p=h.getStart()||0;p<c;p++){b=t[p];l=true;if(f){for(o=0,m=f.length;o<m;o++){l=f[o].filter(b);}}if(l){q.push(b);e++;}if(r&&e===r){break;}}}}if(d){h.setResultSet(new Ext.data.ResultSet({records:q,total:q.length,loaded:true}));h.setSuccessful(true);}else{h.setException("Unable to load records");}},update:function(c){var b=c.getRecords(),f=b.length,e=this.getIds(),a,g,d;
for(d=0;d<f;d++){a=b[d];this.setRecord(a);a.commit();g=a.getId();if(g!==undefined&&Ext.Array.indexOf(e,g)===-1){e.push(g);}}this.setIds(e);c.setSuccessful(true);},erase:function(d){var f=this,c=d.getRecords(),a=f.getIds(),g=a.length,j=[],h={},e=c.length,b;for(;e--;){Ext.apply(h,f.removeRecord(c[e]));
}for(e=0;e<g;e++){b=a[e];if(!h[b]){j.push(b);}}f.setIds(j);d.setSuccessful(true);},getRecord:function(d){var b=this,a=b.cache,c=!a[d]?Ext.decode(b.getStorageObject().getItem(b.getRecordKey(d))):a[d];if(!c){return null;}a[d]=c;c[b.getModel().prototype.idProperty]=d;return Ext.merge({},c);},setRecord:function(j,c){if(c){j.set("id",c,{commit:true});
}else{c=j.getId();}var l=this,a=j.getData(),g={},h=l.getModel(),k=h.getFields(),d=k.length,f=0,m,b,e,o,n;for(;f<d;f++){m=k[f];b=m.name;if(m.persist){n=a[b];if(m.isDateField&&m.dateFormat&&Ext.isDate(n)){n=Ext.Date.format(n,m.dateFormat);}else{if(m.serialize){n=m.serialize(n,j);}}g[b]=n;}}delete g[h.prototype.idProperty];
if(j.isNode&&j.get("depth")===1){delete g.parentId;}e=l.getStorageObject();o=l.getRecordKey(c);l.cache[c]=g;e.removeItem(o);e.setItem(o,Ext.encode(g));},removeRecord:function(a){var d=this,f=a.getId(),b={},c,e;b[f]=a;d.getStorageObject().removeItem(d.getRecordKey(f));delete d.cache[f];if(a.childNodes){e=a.childNodes;
for(c=e.length;c--;){Ext.apply(b,d.removeRecord(e[c]));}}return b;},getRecordKey:function(a){if(a.isModel){a=a.getId();}return Ext.String.format("{0}-{1}",this.getId(),a);},getRecordCounterKey:function(){return Ext.String.format("{0}-counter",this.getId());},getTreeKey:function(){return Ext.String.format("{0}-tree",this.getId());
},getIds:function(){var e=this,c=(e.getStorageObject().getItem(e.getId())||"").split(","),d=c.length,a=this.getIdField().isStringField,b;if(d===1&&c[0]===""){c=[];}else{for(b=0;b<d;b++){c[b]=a?c[b]:+c[b];}}return c;},getIdField:function(){return this.getModel().prototype.idField;},setIds:function(a){var b=this.getStorageObject(),c=a.join(","),d=this.getId();
b.removeItem(d);if(!Ext.isEmpty(c)){b.setItem(d,c);}},getNextId:function(){var c=this,d=c.getStorageObject(),b=c.getRecordCounterKey(),a=c.getIdField().isStringField,e;e=c.idGenerator.generate();d.setItem(b,e);if(a){e=e+"";}return e;},getTreeData:function(){var m=this,a=m.getIds(),e=a.length,h=[],b={},n=[],j=0,g=m.getModel(),p=g.prototype.idProperty,f,l,o,k,d,c;
for(;j<e;j++){c=a[j];l=m.getRecord(c);h.push(l);b[c]=l;if(!l.parentId){n.push(l);}}f=n.length;Ext.Array.sort(h,m.sortByParentId);for(j=f;j<e;j++){l=h[j];k=l.parentId;if(!o||o[p]!==k){o=b[k];o.children=d=[];}d.push(l);}for(j=e;j--;){l=h[j];if(!l.children&&!l.leaf){l.loaded=true;}}for(j=f;j--;){l=n[j];
n[j]=new g(l);}return n;},sortByParentId:function(b,a){return(b.parentId||0)-(a.parentId||0);},initialize:function(){var b=this,a=b.getStorageObject(),c=+a.getItem(b.getRecordCounterKey()),d=b.getId();a.setItem(d,a.getItem(d)||"");if(a.getItem(b.getTreeKey())){b.isHierarchical=true;}b.idGenerator=new Ext.data.identifier.Sequential({seed:c?c+1:1});
},clear:function(){var d=this,e=d.getStorageObject(),c=d.getIds(),a=c.length,b;for(b=0;b<a;b++){e.removeItem(d.getRecordKey(c[b]));}e.removeItem(d.getRecordCounterKey());e.removeItem(d.getTreeKey());e.removeItem(d.getId());d.cache={};},getStorageObject:function(){Ext.raise("The getStorageObject function has not been defined in your Ext.data.proxy.WebStorage subclass");
}});