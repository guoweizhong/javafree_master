Ext.define("Ext.data.virtual.PageMap",{requires:["Ext.data.virtual.Page"],isVirtualPageMap:true,config:{cacheSize:10,concurrentLoading:1,pageCount:null},generation:0,store:null,constructor:function(a){var b=this;b.prefetchSortFn=b.prefetchSortFn.bind(b);b.initConfig(a);b.clear();},destroy:function(){this.clear(true);
this.callParent();},canSatisfy:function(b){var a=this.getPageIndex(b.end),c=this.getPageCount();return c===null||a<c;},clear:function(b){var d=this,c=!b||null,a=d.pages,e;++d.generation;d.byId=c&&{};d.byInternalId=c&&{};d.cache=c&&[];d.indexMap=c&&{};d.pages=c&&{};d.loading=c&&[];d.loadQueues=c&&{active:[],prefetch:[]};
if(a){for(e in a){a[e].destroy();}}},getPage:function(d,f){var c=this,b=c.getPageCount(),a=c.pages,e;if(b===null||d<b){e=a[d];if(!e&&f!==false){a[d]=e=new Ext.data.virtual.Page({pageMap:c,number:d});}}else{Ext.raise("Invalid page number "+d+" when limit is "+b);}return e||null;},getPageIndex:function(a){if(a.isEntity){a=this.indexOf(a);
}return Math.floor(a/this.store.getPageSize());},getPageOf:function(b,c){var a=this.store.getPageSize(),d=Math.floor(b/a);return this.getPage(d,c);},getPages:function(d,b){var a=this.store.getPageSize(),f=Math.floor(d/a),e=Math.ceil(b/a),c={},g;for(g=f;g<e;++g){c[g]=this.getPage(g);}return c;},flushNextLoad:function(){var b=this,a=b.queueTimer;
if(a){Ext.asapCancel(a);}b.loadNext();},indexOf:function(a){var b=this.indexMap[a.internalId];return(b||b===0)?b:-1;},getByInternalId:function(a){var b=this.indexMap[a],c;if(b||b===0){c=this.pages[Math.floor(b/this.store.getPageSize())];if(c){return c.records[b-c.begin];}}},updatePageCount:function(c,e){var a=this.pages,b,d;
if(e===null||c<e){for(b in a){d=a[b];if(d.number>=c){this.clearPage(d);d.destroy();}}}},privates:{queueTimer:null,clearPage:function(d,b){var c=this,a=Ext.Array,e=c.loadQueues;delete c.pages[d.number];d.clearRecords(c.byId,"id");d.clearRecords(c.byInternalId,"internalId");d.clearRecords(c.indexMap,"internalId");
a.remove(e.active,d);a.remove(e.prefetch,d);if(!b){Ext.Array.remove(c.cache,d);}},loadNext:function(){var b=this,a=b.getConcurrentLoading(),e=b.loading,d=b.loadQueues,c;b.queueTimer=null;while(e.length<a){if(!(c=d.active.shift()||d.prefetch.shift())){break;}e.push(c);c.load();}},onPageLoad:function(e){var d=this,b=d.store,a=b.activeRanges,f=a.length,c;
Ext.Array.remove(d.loading,e);if(!e.error){e.fillRecords(d.byId,"id");e.fillRecords(d.byInternalId,"internalId");e.fillRecords(d.indexMap,"internalId",true);b.onPageDataAcquired(e);for(c=0;c<f;++c){a[c].onPageLoad(e);}}d.flushNextLoad();},onPageLockChange:function(f,e,b){var d=this,a=d.cache,g=d.loadQueues,h,c;
if(f.isInitial()){if(b){Ext.Array.remove(g[b],f);}if(e){g[e].push(f);c=d.getConcurrentLoading();if(!d.queueTimer&&d.loading.length<c){d.queueTimer=Ext.asap(d.loadNext,d);}}}if(e){if(!b){Ext.Array.remove(a,f);}}else{a.push(f);for(h=d.getCacheSize();a.length>h;){f=a.shift();d.clearPage(f,true);d.store.onPageEvicted(f);
f.destroy();}}},prefetchSortFn:function(j,h){j=j.number;h=h.number;var f=Math,c=this.sortFirstPage,d=this.sortLastPage,i=this.sortDirection,k=j<c,g=h<c,e;j=k?f.abs(c-j):f.abs(d-j);h=g?f.abs(c-h):f.abs(d-h);if(j===h){e=k?i:-i;}else{e=j-h;}return e;},prioritizePrefetch:function(c,d,b){var a=this;a.sortDirection=c;
a.sortFirstPage=d;a.sortLastPage=b;a.loadQueues.prefetch.sort(a.prefetchSortFn);}}});