Ext.define("Ext.data.BufferedStore",{extend:"Ext.data.ProxyStore",alias:"store.buffered",requires:["Ext.data.PageMap","Ext.util.Filter","Ext.util.Sorter","Ext.util.Grouper"],uses:["Ext.util.SorterCollection","Ext.util.FilterCollection","Ext.util.GroupCollection"],isBufferedStore:true,buffered:true,config:{data:0,pageSize:25,remoteSort:true,remoteFilter:true,sortOnLoad:false,purgePageCount:5,trailingBufferZone:25,leadingBufferZone:200,defaultViewSize:100,viewSize:0,trackRemoved:false},applyData:function(b){var a=this.data||(this.data=this.createDataCollection());
if(b&&b!==true){Ext.raise("Cannot load a buffered store with local data - the store is a map of remote data");}return a;},applyProxy:function(a){a=this.callParent([a]);if(a&&a.setEnablePaging){a.setEnablePaging(true);}return a;},applyAutoSort:function(){},createFiltersCollection:function(){return new Ext.util.FilterCollection();
},createSortersCollection:function(){return new Ext.util.SorterCollection();},updateRemoteFilter:function(a,b){if(a===false){Ext.raise("Buffered stores are always remotely filtered.");}this.callParent([a,b]);},updateRemoteSort:function(b,a){if(b===false){Ext.raise("Buffered stores are always remotely sorted.");
}this.callParent([b,a]);},updateTrackRemoved:function(a){if(a!==false){Ext.raise("Cannot use trackRemoved with a buffered store.");}this.callParent(arguments);},updateGroupField:function(a){this.group(a);},getGrouper:function(){return this.grouper;},isGrouped:function(){return !!this.grouper;},createDataCollection:function(){var b=this,a=new Ext.data.PageMap({store:b,rootProperty:"data",pageSize:b.getPageSize(),maxSize:b.getPurgePageCount(),listeners:{clear:b.onPageMapClear,scope:b}});
b.relayEvents(a,["beforepageremove","pageadd","pageremove"]);b.pageRequests={};return a;},add:function(){Ext.raise("add method may not be called on a buffered store - the store is a map of remote data");},insert:function(){Ext.raise("insert method may not be called on a buffered store - the store is a map of remote data");
},removeAll:function(a){var b=this,c=b.getData();if(c){if(a){b.suspendEvent("clear");}c.clear();if(a){b.resumeEvent("clear");}}},flushLoad:function(){var b=this,a=b.pendingLoadOptions;b.clearLoadTask();if(!a){return;}if(!a.preserveOnFlush){b.getData().clear();a.page=1;a.start=0;a.limit=b.getViewSize()||b.getDefaultViewSize();
}a.loadCallback=a.callback;a.callback=null;return b.loadToPrefetch(a);},reload:function(m){var g=this,e=g.getData(),j=Number.MAX_VALUE,h,b,f,l,d,a,k,c;if(!m){m={};}if(g.loading||g.fireEvent("beforeload",g,m)===false){return;}a=function(){var n=g.totalCount,i=b-h;if(b>=n){b=n-1;h=Math.max(b-i,0);}if(g.rangeCached(h,b,false)){g.loadCount=(g.loadCount||0)+1;
g.loading=false;e.un("pageadd",a);c=e.getRange(h,b);g.fireEvent("refresh",g);g.fireEvent("load",g,c,true);}};k=Math.ceil((g.getLeadingBufferZone()+g.getTrailingBufferZone())/2);if(g.lastRequestStart&&g.preserveScrollOnReload){h=g.lastRequestStart;b=g.lastRequestEnd;j=g.getTotalCount();}else{h=m.start||0;
b=h+(m.count||g.getPageSize())-1;}e.clear(true);delete g.totalCount;h=Math.max(h-k,0);b=Math.min(b+k,j);h=h===0?0:h-1;b=b===j?b:b+1;f=g.getPageFromRecordIndex(h);l=g.getPageFromRecordIndex(b);g.loading=true;m.waitForReload=a;e.on("pageadd",a);for(d=f;d<=l;d++){g.prefetchPage(d,m);}},filter:function(){if(!this.getRemoteFilter()){Ext.raise("Local filtering may not be used on a buffered store - the store is a map of remote data");
}this.callParent(arguments);},filterBy:function(b,a){Ext.raise("Local filtering may not be used on a buffered store - the store is a map of remote data");},loadData:function(b,a){Ext.raise("LoadData may not be used on a buffered store - the store is a map of remote data");},loadPage:function(c,a){var b=this;
a=a||{};a.page=b.currentPage=c;a.start=(c-1)*b.getPageSize();a.limit=b.getViewSize()||b.getDefaultViewSize();a.loadCallback=a.callback;a.callback=null;a.preserveOnFlush=true;return b.load(a);},clearData:function(c){var a=this,b=a.getData();if(b){b.clear();}},getCount:function(){return this.totalCount||0;
},getRange:function(d,g,l){var k=this,e=k.totalCount-1,f=k.lastRequestStart,m=[],h=k.getData(),c,j,b,a,i;l=Ext.apply({prefetchStart:d,prefetchEnd:g},l);g=(g>=k.totalCount)?e:g;if(l.forRender!==false){j=d===0?0:d-1;b=g===e?g:g+1;}else{j=d;b=g;}k.lastRequestStart=d;k.lastRequestEnd=g;if(k.rangeCached(d,g,l.forRender)){k.onRangeAvailable(l);
m=h.getRange(d,g+1);}else{k.fireEvent("cachemiss",k,d,g);a=k.getPageFromRecordIndex(j);i=k.getPageFromRecordIndex(b);c=function(n,p,o){if(p>=a&&p<=i&&k.rangeCached(d,g)){k.fireEvent("cachefilled",k,d,g);h.un("pageadd",c);k.onRangeAvailable(l);}};h.on("pageadd",c);k.prefetchRange(d,g);}k.primeCache(d,g,d<f?-1:1);
return m;},getById:function(b){var a=this.data.findBy(function(c){return c.getId()===b;});return a;},getAt:function(a){var b=this.getData();if(b.hasRange(a,a)){return b.getAt(a);}},getByInternalId:function(a){return this.data.getByInternalId(a);},contains:function(a){return this.indexOf(a)>-1;},indexOf:function(a){return this.getData().indexOf(a);
},indexOfId:function(a){return this.indexOf(this.getById(a));},group:function(b,d){var c=this,a;if(b&&typeof b==="string"){a=c.grouper;if(a&&d!==undefined){a.setDirection(d);}else{c.grouper=new Ext.util.Grouper({property:b,direction:d||"ASC",root:"data"});}}else{c.grouper=b?c.getSorters().decodeSorter(b,Ext.util.Grouper):null;
}c.getData().clear();c.loadPage(1,{callback:function(){c.fireEvent("groupchange",c,c.getGrouper());}});},getPageFromRecordIndex:function(a){return Math.floor(a/this.getPageSize())+1;},calculatePageCacheSize:function(a){var c=this,b=c.getPurgePageCount();return b?Math.max(c.getData().getMaxSize()||0,Math.ceil((a+c.getTrailingBufferZone()+c.getLeadingBufferZone())/c.getPageSize())*2+b):0;
},loadToPrefetch:function(r){var l=this,c=r,g,b,n,m=r.start,a=r.start+r.limit-1,q=(l.getViewSize()||r.limit),h=Math.min(a,r.start+q-1),j=l.getPageFromRecordIndex(Math.max(m-l.getTrailingBufferZone(),0)),p=l.getPageFromRecordIndex(a+l.getLeadingBufferZone()),f=l.getData(),k=function(){b=b||[];if(r.loadCallback){r.loadCallback.call(r.scope||l,b,e,true);
}if(r.callback){r.callback.call(r.scope||l,b,m||0,a||0,r);}},o=function(){l.loadCount=(l.loadCount||0)+1;l.fireEvent("datachanged",l);l.fireEvent("refresh",l);l.fireEvent("load",l,b,true);},d=function(){if(l.rangeCached(m,h)){l.loading=false;b=f.getRange(m,h+1);f.un("pageadd",d);if(l.hasListeners.guaranteedrange){l.guaranteeRange(m,h,r.callback,r.scope);
}k();o();}},e;if(isNaN(l.pageSize)||!l.pageSize){Ext.raise("Buffered store configured without a pageSize",l);}f.setMaxSize(l.calculatePageCacheSize(q));if(l.fireEvent("beforeload",l,r)!==false){delete l.totalCount;l.loading=true;if(r.callback){c=Ext.apply({},r);delete c.callback;}l.on("prefetch",function(s,i,u,t){e=t;
if(u){if((n=l.getTotalCount())){f.on("pageadd",d);h=Math.min(h,n-1);p=l.getPageFromRecordIndex(Math.min(h+l.getLeadingBufferZone(),n-1));for(g=j+1;g<=p;++g){l.prefetchPage(g,c);}}else{k();o();}}else{l.loading=false;k();l.fireEvent("load",l,i,false);}},null,{single:true});l.prefetchPage(j,c);}},prefetch:function(d){var e=this,b=e.getPageSize(),f=e.getData(),c,a;
if(b){if(e.lastPageSize&&b!=e.lastPageSize){Ext.raise("pageSize cannot be dynamically altered");}if(!f.getPageSize()){f.setPageSize(b);}}else{e.pageSize=f.setPageSize(b=d.limit);}e.lastPageSize=b;if(!d.page){d.page=e.getPageFromRecordIndex(d.start);d.start=(d.page-1)*b;d.limit=Math.ceil(d.limit/b)*b;
}a=e.pageRequests[d.page];if(!a||a.getOperation().pageMapGeneration!==f.pageMapGeneration){d=Ext.apply({action:"read",filters:e.getFilters().items,sorters:e.getSorters().items,grouper:e.getGrouper(),internalCallback:e.onProxyPrefetch,internalScope:e},d);c=e.createOperation("read",d);c.pageMapGeneration=f.pageMapGeneration;
if(e.fireEvent("beforeprefetch",e,c)!==false){e.pageRequests[d.page]=c.execute();if(e.getProxy().isSynchronous){delete e.pageRequests[d.page];}}}return e;},onPageMapClear:function(){var c=this,b=c.wasLoading,a=c.pageRequests,e=c.getData(),d;e.clearListeners();e.on("clear",c.onPageMapClear,c);c.relayEvents(e,["beforepageremove","pageadd","pageremove"]);
c.loading=true;c.totalCount=0;for(d in a){if(a.hasOwnProperty(d)){a[d].getOperation().abort();}}c.fireEvent("clear",c);c.loading=b;},prefetchPage:function(e,b){var d=this,a=d.getPageSize(),f=(e-1)*a,c=d.totalCount;if(c!==undefined&&d.data.getCount()===c){return;}d.prefetch(Ext.applyIf({page:e,start:f,limit:a},b));
},onProxyPrefetch:function(d){if(this.destroying||this.destroyed){return;}var h=this,i=d.getResultSet(),c=d.getRecords(),f=d.wasSuccessful(),g=d.getPage(),b=d.waitForReload,k=h.totalCount,a=h.pageRequests,j,e;if(d.pageMapGeneration===h.getData().pageMapGeneration){if(i){h.totalCount=i.getTotal();if(h.totalCount!==k){h.fireEvent("totalcountchange",h.totalCount);
}}if(g!==undefined){delete h.pageRequests[g];}h.loading=false;h.fireEvent("prefetch",h,c,f,d);if(f){if(h.totalCount===0){if(b){for(j in a){e=a[j].getOperation();if(e.waitForReload===b){delete e.waitForReload;}}h.getData().un("pageadd",b);h.fireEvent("refresh",h);h.fireEvent("load",h,[],true);}}else{h.cachePage(c,d.getPage());
}}Ext.callback(d.getCallback(),d.getScope()||h,[c,d,f]);}},cachePage:function(b,e){var d=this,a=b.length,c;if(!Ext.isDefined(d.totalCount)){d.totalCount=b.length;d.fireEvent("totalcountchange",d.totalCount);}for(c=0;c<a;c++){b[c].join(d);}d.getData().addPage(e,b);},rangeCached:function(e,a,d){var c=e,b=a;
if(d!==false){c=e===0?0:e-1,b=a===this.totalCount-1?a:a+1;}return this.getData().hasRange(c,b);},pageCached:function(a){return this.getData().hasPage(a);},pagePending:function(a){return !!this.pageRequests[a];},rangeSatisfied:function(b,a){return this.rangeCached(b,a);},onRangeAvailable:function(d){var e=this,b=e.getTotalCount(),f=d.prefetchStart,a=(d.prefetchEnd>b-1)?b-1:d.prefetchEnd,c;
a=Math.max(0,a);if(f>a){Ext.log({level:"warn",msg:"Start ("+f+") was greater than end ("+a+") for the range of records requested ("+f+"-"+d.prefetchEnd+")"+(this.storeId?' from store "'+this.storeId+'"':"")});}c=e.getData().getRange(f,a+1);if(d.fireEvent!==false){e.fireEvent("guaranteedrange",c,f,a,d);
}if(d.callback){d.callback.call(d.scope||e,c,f,a,d);}},guaranteeRange:function(e,a,d,c,b){b=Ext.apply({callback:d,scope:c},b);this.getRange(e,a+1,b);},prefetchRange:function(g,b){var d=this,c,a,f,e=d.getData();if(!d.rangeCached(g,b)){c=d.getPageFromRecordIndex(g);a=d.getPageFromRecordIndex(b);e.setMaxSize(d.calculatePageCacheSize(b-g+1));
for(f=c;f<=a;f++){if(!d.pageCached(f)){d.prefetchPage(f);}}}},primeCache:function(h,c,g){var f=this,e=f.getLeadingBufferZone(),d=f.getTrailingBufferZone(),b=f.getPageSize(),a=f.totalCount;if(g===-1){h=Math.max(h-e,0);c=Math.min(c+d,a-1);}else{if(g===1){h=Math.max(Math.min(h-d,a-b),0);c=Math.min(c+e,a-1);
}else{h=Math.min(Math.max(Math.floor(h-((e+d)/2)),0),a-f.pageSize);c=Math.min(Math.max(Math.ceil(c+((e+d)/2)),0),a-1);}}f.prefetchRange(h,c);},sort:function(b,a,c){if(arguments.length===0){this.clearAndLoad();}else{this.getSorters().addSort(b,a,c);}},onSorterEndUpdate:function(){var a=this,b=a.getSorters().getRange();
if(b.length){a.fireEvent("beforesort",a,b);a.clearAndLoad({callback:function(){a.fireEvent("sort",a,b);}});}else{a.fireEvent("sort",a,b);}},clearAndLoad:function(a){var b=this;b.clearing=true;b.getData().clear();b.clearing=false;b.loadPage(1,a);},privates:{isLast:function(a){return this.indexOf(a)===this.getTotalCount()-1;
},isMoving:function(){return false;}}});