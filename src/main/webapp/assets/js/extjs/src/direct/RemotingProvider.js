Ext.define("Ext.direct.RemotingProvider",{extend:"Ext.direct.JsonProvider",alias:"direct.remotingprovider",requires:["Ext.util.MixedCollection","Ext.util.DelayedTask","Ext.direct.Transaction","Ext.direct.RemotingMethod","Ext.direct.Manager"],type:"remoting",enableBuffer:10,bufferLimit:Number.MAX_VALUE,maxRetries:1,constructor:function(a){var b=this;
b.callParent([a]);b.namespace=(Ext.isString(b.namespace))?Ext.ns(b.namespace):b.namespace||Ext.global;b.callBuffer=[];},destroy:function(){if(this.callTask){this.callTask.cancel();}this.callParent();},connect:function(){var a=this;if(!a.url){Ext.raise('Error initializing RemotingProvider "'+a.id+'", no url configured.');
}a.callParent();},doConnect:function(){if(!this.apiCreated){this.initAPI();this.apiCreated=true;}},getNamespace:function(b,e){var f,d,c,a;b=b||Ext.global;f=e.toString().split(".");for(c=0,a=f.length;c<a;c++){d=f[c];b=b[d];if(typeof b==="undefined"){return b;}}return b;},createNamespaces:function(b,e){var f,d,c,a;
b=b||Ext.global;f=e.toString().split(".");for(c=0,a=f.length;c<a;c++){d=f[c];b[d]=b[d]||{};b=b[d];}return b;},initAPI:function(){var j=this,f=j.actions,d=j.namespace,b=Ext.direct.Manager,e,l,c,g,h,a,k;for(e in f){if(f.hasOwnProperty(e)){if(j.disableNestedActions){l=d[e];if(!l){l=d[e]={};}}else{l=j.getNamespace(d,e);
if(!l){l=j.createNamespaces(d,e);}}c=f[e];for(g=0,h=c.length;g<h;++g){a=new Ext.direct.RemotingMethod(c[g]);l[a.name]=k=j.createHandler(e,a);b.registerMethod(k.$name,k);}}}},createHandler:function(c,d){var b=this,a;a=function(){b.invokeFunction(c,d,Array.prototype.slice.call(arguments,0));};a.name=a.$name=c+"."+d.name;
a.$directFn=true;a.directCfg=a.$directCfg={action:c,method:d};return a;},invokeFunction:function(e,h,b){var d=this,f,c,a,g;f=d.configureTransaction(e,h,b);if(d.fireEvent("beforecall",d,f,h)!==false){Ext.direct.Manager.addTransaction(f);if(f.isForm){c=f.form;a=String(c.getAttribute("enctype")).toLowerCase()==="multipart/form-data";
g={extTID:f.id,extAction:e,extMethod:h.name,extType:"rpc",extUpload:String(a)};if(f.metadata){g.extMetadata=Ext.JSON.encode(f.metadata);}Ext.apply(f,{form:c,isUpload:a,params:g});}d.queueTransaction(f);d.fireEvent("call",d,f,h);}},configureTransaction:function(f,h,c){var e,a,d,b,g;e=h.getCallData(c);
a=e.callback;d=e.scope;b=e.options;if(a&&!Ext.isFunction(a)){Ext.raise("Callback argument is not a function "+"for Ext Direct method "+f+"."+h.name);}a=a&&d?Ext.Function.bind(a,d):a;g=Ext.apply({},{provider:this,args:c,action:f,method:h.name,form:e.form,data:e.data,metadata:e.metadata,callbackOptions:b,callback:a,isForm:!!h.formHandler,disableBatching:h.disableBatching});
if(b&&b.timeout!=null){g.timeout=b.timeout;}return new Ext.direct.Transaction(g);},queueTransaction:function(d){var c=this,b=c.callBuffer,a=c.enableBuffer;if(d.isForm||a===false||d.disableBatching||d.timeout!=null){c.sendTransaction(d);return;}b.push(d);if(a&&b.length<c.bufferLimit){if(!c.callTask){c.callTask=new Ext.util.DelayedTask(c.combineAndSend,c);
}c.callTask.delay(Ext.isNumber(a)?a:10);}else{c.combineAndSend();}},combineAndSend:function(){var c=this,b=c.callBuffer,a=b.length;if(a>0){c.sendTransaction(a===1?b[0]:b);c.callBuffer=[];}},sendTransaction:function(a){var g=this,d,b,c,j=g.enableUrlEncode,h,e,f;d={url:g.url,callback:g.onData,scope:g,transaction:a,headers:g.getHeaders()};
if(a.timeout!=null){d.timeout=a.timeout;}else{if(g.timeout!=null){d.timeout=g.timeout;}}if(a.isForm){Ext.apply(d,{params:a.params,form:a.form,isUpload:a.isUpload});}else{if(Ext.isArray(a)){b=[];for(e=0,f=a.length;e<f;++e){h=g.getPayload(a[e]);b.push(h);}}else{b=g.getPayload(a);}if(j){c={};c[Ext.isString(j)?j:"data"]=Ext.encode(b);
d.params=c;}else{d.jsonData=b;}}return g.sendAjaxRequest(d);},getPayload:function(b){var a={action:b.action,method:b.method,data:b.data,type:"rpc",tid:b.id};if(b.metadata){a.metadata=b.metadata;}return a;},onData:function(k,h,c){var f=this,d,e,j,a,b,g;if(f.destroying||f.destroyed){return;}j=h&&f.createEvents(c);
h=j&&j.length&&!j[0].parsingError;if(h){for(d=0,e=j.length;d<e;++d){a=j[d];f.fireEvent("data",f,a);b=f.getTransaction(a);if(b){if(f.fireEvent("beforecallback",f,a,b)!==false){f.runCallback(b,a,true);}Ext.direct.Manager.removeTransaction(b);}}}else{g=[].concat(k.transaction);a=j[0]||new Ext.direct.ExceptionEvent({data:null,transaction:b,code:Ext.direct.Manager.exceptions.TRANSPORT,message:"Unable to connect to the server.",xhr:c});
for(d=0,e=g.length;d<e;++d){b=f.getTransaction(g[d]);if(b&&b.retryCount<f.maxRetries){b.retry();}else{f.fireEvent("data",f,a);f.fireEvent("exception",f,a);if(b&&f.fireEvent("beforecallback",f,a,b)!==false){f.runCallback(b,a,false);}Ext.direct.Manager.removeTransaction(b);}}}f.callParent([k,h,c]);},getTransaction:function(a){return a&&a.tid?Ext.direct.Manager.getTransaction(a.tid):null;
},runCallback:function(f,c){var e=!!c.status,d=e?"success":"failure",g,b,a;if(f&&f.callback){g=f.callback;b=f.callbackOptions;a=typeof c.result!=="undefined"?c.result:c.data;if(Ext.isFunction(g)){g(a,c,e,b);}else{Ext.callback(g[d],g.scope,[a,c,e,b]);Ext.callback(g.callback,g.scope,[a,c,e,b]);}}},inheritableStatics:{checkConfig:function(a){return a&&a.type==="remoting"&&a.url&&Ext.isArray(a.actions);
}}});