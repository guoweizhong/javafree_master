<%@ page contentType="text/html; charset=UTF-8" %><script type="text/javascript">var current_deptid="${param.current_deptid}";var selectDeptMemberParentWinGridPanel=Ext.getCmp("${param.parentWinGridPanelID}");var selectDeptMemberWin=Ext.getCmp("${param.popupwinid}");Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var i=50;var j=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson?forType=userList";var q=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:j},folderSort:false});q.sort({property:"sn",direction:"ASC"},"prepend",false);var f=javafree.CONTEXTPATH+"/identity/user/doGetUserByDeptIdGridJson";var g=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"displayName",type:"string"},{name:"email",type:"string"},{name:"enabled",type:"string"},{name:"createDate",type:"string"},{name:"mobile",type:"string"},{name:"orgcode",type:"string"},{name:"sn",type:"int"}],pageSize:i,proxy:{type:"jsonp",enablePaging:true,url:f,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});var k=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"展开",scope:this,handler:function(){d.getEl().mask("正在展开...");d.expandAll(function(){d.getEl().unmask()})}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"折叠",handler:function(){d.collapseAll()}}];var d=Ext.create("Ext.tree.Panel",{title:"",tbar:k,useArrows:false,rootVisible:false,store:q,multiSelect:true,forceFit:true,columns:[{xtype:"treecolumn",text:"机构树",width:380,sortable:true,dataIndex:"name"}],listeners:{itemclick:function(t,s,w,u,x,v){Ext.apply(g.proxy.extraParams,{deptid:s.data.id});g.load({params:{start:0,limit:i}})}}});var c=Ext.create("Ext.data.Store",{fields:["value","name"],data:[{value:"displayName",name:"用户名称"},{value:"name",name:"登录帐号"},{value:"mobile",name:"电话"},{value:"email",name:"邮箱"}]});var m=[{fieldLabel:"查询",labelWidth:30,id:"fieldName_userlist",xtype:"combobox",emptyText:"选择字段",name:"fieldName_userlist",displayField:"name",valueField:"value",width:140,store:c,queryMode:"local",listeners:{select:function(){Ext.apply(g.proxy.extraParams,{fieldName:Ext.getCmp("fieldName_userlist").getValue()})}},fieldStyle:"border-right: 0px!important;border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;"},{width:140,fieldLabel:"查询",emptyText:"输入字段值...",hideLabel:true,labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:g}];var a=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var p=Ext.create("Ext.grid.Panel",{title:"",tbar:m,selModel:a,multiSelect:true,forceFit:true,store:g,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"displayName",width:120},{header:"帐号",dataIndex:"name",width:120},{header:"机构编码",dataIndex:"orgcode",hidden:true,width:100}],bbar:{xtype:"pagingtoolbar",store:g,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});var h=javafree.CONTEXTPATH+"/identity/role/doGetRoleGridJson";var b=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"createDate",type:"string"},{name:"scopetype",type:"string"},{name:"sn",type:"int"}],pageSize:i,proxy:{type:"jsonp",enablePaging:true,url:h,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:true,remoteSort:true,groupField:"note",sorters:{property:"note",direction:"DESC"}});var e=[{width:150,fieldLabel:"查询",emptyText:"角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:b},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){l()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectDeptMemberWin){selectDeptMemberWin.close()}}}];function l(){var y=p.getSelectionModel().getSelection();var z=n.getSelectionModel().getSelection();if(current_deptid&&current_deptid.length>1){if(y.length>0&&z.length>0){var v=[],A=[],w=[],s=[];for(var u=0,x=y.length;u<x;u++){v.push(y[u].get("id"));A.push(y[u].get("displayName"))}for(var u=0,x=z.length;u<x;u++){w.push(z[u].get("id"));s.push(z[u].get("name"))}var t=javafree.CONTEXTPATH+"/identity/membership/doAddMembership";Ext.Ajax.request({url:t,method:"POST",scope:this,params:{current_deptid:current_deptid,userids:v.toString(),userNames:A.toString(),roleids:w.toString(),roleNames:s.toString()},success:function(B){var C=Ext.JSON.decode(B.responseText);if(C.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:C.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(selectDeptMemberParentWinGridPanel){selectDeptMemberParentWinGridPanel.store.load()}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:C.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(B){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}else{Ext.MessageBox.show({title:"错误提示:",msg:"需要同时选择用户和角色后才能提交!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}else{Ext.MessageBox.show({title:"错误提示:",msg:"没有获得到机构信息,请返回主界面选择!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}var r=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var n=Ext.create("Ext.grid.Panel",{title:"",tbar:e,selModel:r,multiSelect:true,forceFit:true,store:b,features:[{id:"group",ftype:"grouping",groupHeaderTpl:"{name}({rows.length})"}],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"角色名称",dataIndex:"name",width:120},{header:"机构编码",width:120,sortable:true,hidden:true,dataIndex:"orgcode"},{header:"适用范围",width:100,sortable:true,align:"center",hidden:true,dataIndex:"scopetype"}],bbar:{xtype:"pagingtoolbar",store:b,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});var o=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{},defaults:{split:true},items:[{region:"west",title:"",split:false,width:"35%",border:true,minWidth:100,maxSize:400,autoScroll:true,layout:"fit",items:d},{region:"center",width:"65%",style:{borderLeft:"1px solid #cecece"},border:false,minWidth:200,maxSize:500,split:false,autoScroll:true,layout:"fit",items:p}]});dept_member_viewport=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderTop:"1px solid #cecece"},items:[{region:"west",title:"第一步：选择用户",split:false,width:"58%",border:false,minWidth:200,maxSize:400,autoScroll:true,layout:"fit",items:o},{title:"第二步：选择角色",region:"center",width:"42%",border:false,style:{borderLeft:"2px solid #cecece"},minWidth:200,maxSize:500,split:false,autoScroll:true,layout:"fit",floatable:true,items:n}]});selectDeptMemberWin.removeAll();selectDeptMemberWin.add(dept_member_viewport)});</script>