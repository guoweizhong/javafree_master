<%@ page contentType="text/html; charset=UTF-8"%><script type="text/javascript">var current_orgcodeids="${param.current_orgcodeids}";var selectOrgcodeAdminParentWinGridPanel=Ext.getCmp("${param.parentWinGridPanelID}");var selectOrgcodeAdminWin=Ext.getCmp("${param.popupwinid}");Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var b=50;var l=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson?forType=userList";var k=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:l},folderSort:false});k.sort({property:"sn",direction:"ASC"},"prepend",false);var c=javafree.CONTEXTPATH+"/identity/user/doGetUserByDeptIdGridJson";var j=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"displayName",type:"string"},{name:"email",type:"string"},{name:"enabled",type:"string"},{name:"createDate",type:"string"},{name:"mobile",type:"string"},{name:"sn",type:"int"}],pageSize:b,proxy:{type:"jsonp",enablePaging:true,url:c,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});Ext.apply(j.proxy.extraParams,{adminType:"ORG"});var h=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"展开",scope:this,handler:function(){i.getEl().mask("正在展开...");i.expandAll(function(){i.getEl().unmask()})}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"折叠",handler:function(){i.collapseAll()}}];var i=Ext.create("Ext.tree.Panel",{title:"",tbar:h,useArrows:false,rootVisible:false,store:k,multiSelect:true,forceFit:true,columns:[{xtype:"treecolumn",text:"机构树",width:380,sortable:true,dataIndex:"name"}],listeners:{itemclick:function(n,m,q,o,r,p){Ext.apply(j.proxy.extraParams,{deptid:m.data.id});j.load({params:{start:0,limit:b}})}}});var a=[{width:180,fieldLabel:"查询",emptyText:"用户名/帐号...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:j},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){g()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectOrgcodeAdminWin){selectOrgcodeAdminWin.close()}}}];var f=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var d=Ext.create("Ext.grid.Panel",{title:"",tbar:a,selModel:f,multiSelect:true,forceFit:true,store:j,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"displayName",width:100},{header:"帐号",dataIndex:"name",width:100},{header:"电话",dataIndex:"mobile",width:120}],bbar:{xtype:"pagingtoolbar",store:j,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});function g(){var n=d.getSelectionModel().getSelection();if(current_orgcodeids&&current_orgcodeids.length>1){if(n.length>0){var s=[],o=[],r=[];for(var q=0,m=n.length;q<m;q++){s.push(n[q].get("id"));o.push(n[q].get("name"));r.push(n[q].get("displayName"))}var p=javafree.CONTEXTPATH+"/identity/orgcodeAdmin/doAddOrgcodeAdmin";Ext.Ajax.request({url:p,method:"POST",scope:this,params:{current_orgcodeids:current_orgcodeids,userNames:o.toString(),userDisplayNames:r.toString()},success:function(t){var u=Ext.JSON.decode(t.responseText);if(u.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:u.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(selectOrgcodeAdminParentWinGridPanel){selectOrgcodeAdminParentWinGridPanel.store.load()}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:u.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(t){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}else{Ext.MessageBox.show({title:"错误提示:",msg:"需要选择用户后才能提交!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}else{Ext.MessageBox.show({title:"错误提示:",msg:"没有获得到机构编码信息,请返回主界面选择!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}}var e=Ext.create("Ext.panel.Panel",{layout:{type:"border"},style:{borderTop:"1px solid #cecece"},defaults:{split:true},items:[{region:"west",title:"",split:false,width:"35%",border:true,minWidth:100,maxSize:400,autoScroll:true,layout:"fit",items:i},{region:"center",width:"65%",style:{borderLeft:"1px solid #cecece"},border:false,minWidth:200,maxSize:500,split:false,autoScroll:true,layout:"fit",items:d}]});if(selectOrgcodeAdminWin){selectOrgcodeAdminWin.removeAll();selectOrgcodeAdminWin.add(e)}});</script>