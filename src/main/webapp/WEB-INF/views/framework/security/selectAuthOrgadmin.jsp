<%@ page contentType="text/html; charset=UTF-8"%><script type="text/javascript">var current_resids="${param.current_resids}";var parentWinGridPanel_dept=Ext.getCmp("${param.parentWinGridPanelID_dept}");var parentWinGridPanel_role=Ext.getCmp("${param.parentWinGridPanelID_role}");var parentWinGridPanel_user=Ext.getCmp("${param.parentWinGridPanelID_user}");var parentWinGridPanel_group=Ext.getCmp("${param.parentWinGridPanelID_group}");var parentWinGridPanel_tab=Ext.getCmp("${param.parentWinGridPanelID_tab}");var selectAuthWin=Ext.getCmp("${param.popupwinid}");Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.form.ComboBox","Ext.util.*","Ext.grid.plugin.BufferedRenderer","Ext.toolbar.Paging","Ext.ux.ProgressBarPager","Ext.ux.form.SearchField","Ext.ux.CheckColumn"]);var ICONPATH=javafree.CONTEXTPATH+"/assets/images/";Ext.onReady(function(){var u=50;var I=javafree.CONTEXTPATH+"/identity/user/doGetUserByDeptIdGridJson";var B=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"displayName",type:"string"},{name:"email",type:"string"},{name:"enabled",type:"string"},{name:"createDate",type:"string"},{name:"orgcode",type:"string"},{name:"mobile",type:"string"},{name:"sn",type:"int"}],pageSize:u,proxy:{type:"jsonp",enablePaging:true,url:I,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:false,remoteSort:true,sorters:{property:"sn",direction:"ASC"}});var s=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson?forType=userList";var A=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"orgcode",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:s},folderSort:false});A.sort({property:"sn",direction:"ASC"},"prepend",false);var z=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"展开",scope:this,handler:function(){r.getEl().mask("正在展开...");r.expandAll(function(){r.getEl().unmask()})}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"折叠",handler:function(){r.collapseAll()}}];var r=Ext.create("Ext.tree.Panel",{title:"",tbar:z,useArrows:false,rootVisible:false,store:A,multiSelect:true,forceFit:true,columns:[{xtype:"treecolumn",text:"机构树",width:480,sortable:true,dataIndex:"name"}],listeners:{itemclick:function(K,J,N,L,O,M){Ext.apply(B.proxy.extraParams,{deptid:J.data.id});B.load({params:{start:0,limit:u}})}}});var d=Ext.create("Ext.data.Store",{fields:["value","name"],data:[{value:"name",name:"登录帐号"},{value:"displayName",name:"用户名称"},{value:"mobile",name:"电话"},{value:"email",name:"邮箱"}]});var e=[{fieldLabel:"查询",labelWidth:30,id:"fieldName_userlist",xtype:"combobox",emptyText:"选择字段",name:"fieldName_userlist",displayField:"name",valueField:"value",width:140,store:d,queryMode:"local",listeners:{select:function(){Ext.apply(B.proxy.extraParams,{fieldName:Ext.getCmp("fieldName_userlist").getValue()})}},fieldStyle:"border-right: 0px!important;border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;"},{width:140,fieldLabel:"查询",emptyText:"输入字段值...",hideLabel:true,labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:B},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){q()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectAuthWin){selectAuthWin.close()}}}];function q(){var O=o.getSelectionModel().getSelection();if(O.length>0){var M=[],L=[];var Q=[];for(var S=0,T=O.length;S<T;S++){M.push(O[S].get("id"));L.push(O[S].get("displayName")+"("+O[S].get("name")+")");Q.push(O[S].get("orgcode"))}var N=L.toString();var R=M.toString();var P=Q.toString();var K="U";var J=javafree.CONTEXTPATH+"/security/resourceauth/doAddResAuth";Ext.Ajax.request({url:J,method:"POST",scope:this,params:{resids:current_resids,fromType:K,authids:R,authNames:N,orgCodes:P},success:function(U){var V=Ext.JSON.decode(U.responseText);if(V.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:V.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(parentWinGridPanel_user){parentWinGridPanel_user.store.load({callback:function(X,W,Z){if(Z){var Y=0;if(parentWinGridPanel_tab){parentWinGridPanel_tab.items.each(function(aa){++Y;if(Y==1){aa.setTitle("用户("+X.length+")")}})}}}})}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:V.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(U){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}}var x=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function f(K,L,J){K=J.get("displayName");return K}var o=Ext.create("Ext.grid.Panel",{title:"",tbar:e,selModel:x,multiSelect:true,forceFit:true,store:B,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"用户名称",dataIndex:"display_name",renderer:f,locked:true,width:190},{header:"帐号",dataIndex:"name",width:150},{header:"机构编码",width:100,sortable:true,dataIndex:"orgcode"},{text:"次序号",width:70,sortable:true,align:"center",hidden:true,dataIndex:"sn"}],bbar:{xtype:"pagingtoolbar",store:B,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});var y=Ext.create("Ext.panel.Panel",{layout:{type:"border"},defaults:{split:true},items:[{region:"west",title:"",split:true,width:"30%",border:false,minWidth:100,maxSize:400,autoScroll:true,layout:"fit",items:r},{region:"center",width:"70%",border:false,minWidth:100,maxSize:500,split:true,autoScroll:true,layout:"fit",floatable:true,items:o}]});var C=javafree.CONTEXTPATH+"/identity/department/doGetDepartmentTreeJson";var G=Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"sn",type:"int"}],proxy:{type:"ajax",url:C},folderSort:true});G.sort({property:"sn",direction:"ASC"},"prepend",false);var j=[{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-expand.png",text:"",scope:this,handler:function(){i.getEl().mask("正在展开...");i.expandAll(function(){i.getEl().unmask()})}},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/ns-collapse.png",text:"",handler:function(){i.collapseAll()}},"-",{width:220,fieldLabel:"查询",emptyText:"机构/部门名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:G},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){E()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectAuthWin){selectAuthWin.close()}}}];function E(){var O=i.getSelectionModel().getSelection();if(O.length>0){var M=[],L=[];var Q=[];for(var S=0,T=O.length;S<T;S++){M.push(O[S].get("id"));L.push(O[S].get("name"));Q.push(O[S].get("orgcode"))}var N=L.toString();var R=M.toString();var P=Q.toString();var K="D";var J=javafree.CONTEXTPATH+"/security/resourceauth/doAddResAuth";Ext.Ajax.request({url:J,method:"POST",scope:this,params:{resids:current_resids,fromType:K,authids:R,authNames:N,orgCodes:P},success:function(U){var V=Ext.JSON.decode(U.responseText);if(V.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:V.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(parentWinGridPanel_dept){parentWinGridPanel_dept.store.load({callback:function(X,W,Z){if(Z){var Y=0;if(parentWinGridPanel_tab){parentWinGridPanel_tab.items.each(function(aa){++Y;if(Y==2){aa.setTitle("机构/部门("+X.length+")")}})}}}})}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:V.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(U){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}}var D=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function l(K,L,J){if(K=="ORG"){return"机构"}else{return"部门"}}var i=Ext.create("Ext.tree.Panel",{title:"",tbar:j,useArrows:false,rootVisible:false,store:G,selModel:D,multiSelect:true,forceFit:true,columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{xtype:"treecolumn",text:"名称",width:340,sortable:true,dataIndex:"name",locked:true},{text:"类型",width:70,sortable:true,renderer:l,dataIndex:"type"},{header:"机构编码",width:140,sortable:true,dataIndex:"orgcode"},{text:"次序号",width:70,sortable:true,align:"center",dataIndex:"sn"}]});var t=javafree.CONTEXTPATH+"/identity/role/doGetRoleGridJson?scopeType=PRIVATE";var m=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"createDate",type:"string"},{name:"orgcode",type:"string"},{name:"scopetype",type:"string"},{name:"sn",type:"int"}],pageSize:u,proxy:{type:"jsonp",enablePaging:true,url:t,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:true,remoteSort:true,groupField:"note",sorters:{property:"note",direction:"DESC"}});var g=[{width:220,fieldLabel:"查询",emptyText:"角色名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:m},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){p()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectAuthWin){selectAuthWin.close()}}}];function p(){var O=k.getSelectionModel().getSelection();if(O.length>0){var M=[],L=[];var Q=[];for(var S=0,T=O.length;S<T;S++){M.push(O[S].get("id"));L.push(O[S].get("name"));Q.push(O[S].get("orgcode"))}var N=L.toString();var R=M.toString();var P=Q.toString();var K="R";var J=javafree.CONTEXTPATH+"/security/resourceauth/doAddResAuth";Ext.Ajax.request({url:J,method:"POST",scope:this,params:{resids:current_resids,fromType:K,authids:R,authNames:N,orgCodes:P},success:function(U){var V=Ext.JSON.decode(U.responseText);if(V.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:V.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(parentWinGridPanel_role){parentWinGridPanel_role.store.load({callback:function(X,W,Z){if(Z){var Y=0;if(parentWinGridPanel_tab){parentWinGridPanel_tab.items.each(function(aa){++Y;if(Y==3){aa.setTitle("角色("+X.length+")")}})}}}})}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:V.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(U){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}}var c=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});function n(K,L,J){if(K=="PUBLIC"){return"公共"}else{return"私有"}}var k=Ext.create("Ext.grid.Panel",{title:"",tbar:g,selModel:c,multiSelect:true,forceFit:true,store:m,features:[{id:"group",ftype:"grouping",groupHeaderTpl:'<font style="font-weight:bold" color="#00008b">{name}</font><font color="red"> ({rows.length})</font>'}],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"角色名称",dataIndex:"name",width:200},{header:"机构编码",width:120,sortable:true,dataIndex:"orgcode"},{header:"适用范围",width:100,sortable:true,align:"center",renderer:n,dataIndex:"scopetype"},{header:"次序号",dataIndex:"sn",sortable:true,align:"center",width:70}],bbar:{xtype:"pagingtoolbar",store:m,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});var w=javafree.CONTEXTPATH+"/identity/group/doGetGroupGridJson?scopeType=PRIVATE";var F=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"note",type:"string"},{name:"orgcode",type:"string"},{name:"createDate",type:"string"},{name:"scopetype",type:"string"},{name:"sn",type:"int"}],pageSize:u,proxy:{type:"jsonp",enablePaging:true,url:w,reader:{rootProperty:"rows",totalProperty:"total"},simpleSortMode:true},autoLoad:true,remoteSort:true,groupField:"note",sorters:{property:"note",direction:"DESC"}});var v=[{width:220,fieldLabel:"查询",emptyText:"组名称...",labelWidth:30,xtype:"searchfield",fieldStyle:"border-left: 0px!important;border-top: 0px!important;border-bottom: 0px!important;",store:F},{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/accept.png",text:"确定选择",handler:function(){H()}},"-",{pressed:false,cls:"x-btn-text-icon",icon:ICONPATH+"button/delete.png",text:"关闭窗口",handler:function(){if(selectAuthWin){selectAuthWin.close()}}}];function H(){var O=h.getSelectionModel().getSelection();if(O.length>0){var M=[],L=[];var Q=[];for(var S=0,T=O.length;S<T;S++){M.push(O[S].get("id"));L.push(O[S].get("name"));Q.push(O[S].get("orgcode"))}var N=L.toString();var R=M.toString();var P=Q.toString();var K="G";var J=javafree.CONTEXTPATH+"/security/resourceauth/doAddResAuth";Ext.Ajax.request({url:J,method:"POST",scope:this,params:{resids:current_resids,fromType:K,authids:R,authNames:N,orgCodes:P},success:function(U){var V=Ext.JSON.decode(U.responseText);if(V.success==true){Ext.MessageBox.alert({title:"提示信息:",msg:V.info,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO,fn:function(){if(parentWinGridPanel_group){parentWinGridPanel_group.store.load({callback:function(X,W,Z){if(Z){var Y=0;if(parentWinGridPanel_tab){parentWinGridPanel_tab.items.each(function(aa){++Y;if(Y==4){aa.setTitle("组("+X.length+")")}})}}}})}}})}else{Ext.MessageBox.show({title:"错误提示:",msg:V.error,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}},failure:function(U){Ext.MessageBox.show({title:"系统提示信息:",msg:"与服务器端通讯失败,请与管理员联系!",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING})}})}}var b=Ext.create("Ext.selection.CheckboxModel",{columns:[{xtype:"checkcolumn",dataIndex:"id"}]});var h=Ext.create("Ext.grid.Panel",{title:"",tbar:v,selModel:b,multiSelect:true,forceFit:true,store:F,features:[{id:"group",ftype:"grouping",groupHeaderTpl:'<font style="font-weight:bold" color="#00008b">{name}</font><font color="red"> ({rows.length})</font>'}],columns:[new Ext.grid.RowNumberer({header:"NO.",width:35}),{header:"组名称",dataIndex:"name",width:200},{header:"机构编码",width:120,sortable:true,dataIndex:"orgcode"},{header:"适用范围",width:100,sortable:true,align:"center",renderer:n,dataIndex:"scopetype"},{header:"次序号",dataIndex:"sn",sortable:true,align:"center",width:70}],bbar:{xtype:"pagingtoolbar",store:F,displayInfo:true,plugins:new Ext.ux.ProgressBarPager()}});var a=Ext.widget("tabpanel",{activeTab:0,tabPosition:"top",items:[{title:"选择用户",iconCls:"btn-icon-md  orange2 fa fa-user",layout:"fit",items:y},{title:"选择部门",iconCls:"btn-icon-md  orange2 fa fa-sitemap",layout:"fit",items:i},{title:"选择角色",iconCls:"btn-icon-md  orange2 fa fa-child",layout:"fit",items:k},{title:"选择组群",iconCls:"btn-icon-md  orange2 fa fa-users",layout:"fit",items:h}]});if(selectAuthWin){selectAuthWin.removeAll();selectAuthWin.add(a)}});</script>